#!/bin/bash
# -*- mode: sh -*-

# convertor - tool for conversion and work DjVu files
#
# Author: Ale≈° Kapica <kapica@fel.cvut.cz>, 2015
#
# Pou≈æit√≠...
# convertor [test] image
#	provede testovac√≠ konverzi pro v≈°echny dostupn√© separaƒçn√≠ algoritmy didjvu
shopt -s extglob

# Changelog
# - o≈°et≈ôena situace, kdy nen√≠ nainstalov√°n ocrodjvu
# - o≈°et≈ôit situaci, kdy soubor neobsahuje ≈æ√°dn√Ω textov√Ω obsah a soubor dsed, ani xml neexistuje
# - mezi kl√≠ƒçov√© operace p≈ôid√°no delete a insert
# - OCR zpracovan√© do samostatn√© funkce
# - v√Ωchoz√≠ algoritmus djvu; testovac√≠ konverze pro v≈°echny algoritmy se
#   provede pouze je-li uveden parametr --test-conversion
# - implementov√°na rotace str√°nky
# - implementov√°ny p≈ôesuny str√°nek (akce forward a back)
# - implementov√°no generov√°n√≠ n√°hled≈Ø do exportu
# - upraveny funkce pro export n√°hled≈Ø a soubor≈Ø textov√© vrstvy

# ToDo
# - implementovat import
# doplnit n√°povƒõdu k rotaci str√°nky (akce rotate)
# opravit volby --algoritmus a --view
NAME="convertor"
[ -d "${HOME}/.config/${NAME}" ] &&	. ${HOME}/.config/${NAME}/* &>>/dev/null

LOG="${LOG=/dev/null}"
XML="${XML=no}"
DSED="${DSED=no}"
INDIRECT="${INDIRECT=no}"
FORCE="no"
RENAME="no"
SUFFIX=".djvu"
THUMBNAIL="${THUMBNAIL=no}"
INSERTTEXT="${INDIRECT=no}"
ALG="${INDIRECT=djvu}"

trap '''CHYBA=$? ;
case $CHYBA in
 20) echo "Nen√≠ nainstalov√°n bal√≠k djvu-tools"
 ;;
 21) echo "ERROR: mimetype - tool for detection type of image"
 ;;
 22) echo "ERROR: readlink - tool for detection absolute path of directory"
 ;;
 23) echo "Nen√≠ nainstalov√°n bal√≠k netpbm-sf"
 ;;
 24) "ERROR: imagemagick - tool for image convert is not installed"
 ;;
 31) echo "Nen√≠ nainstalov√°n bal√≠k ocrodjvu, na djvu soubory nelze aplikovat OCR. Buƒèto jej doinstalujte, nebo odstra≈àte z p≈ô√≠kazov√© ≈ô√°dky parametr -o (--ocr)" >> /dev/stderr
 ;;
 32) echo "Pokud m√° p≈ôi operaci zpracovat do DjVu bitmapov√Ω soubor, je t≈ôeba uv√©st na p≈ô√≠kazov√© ≈ô√°dce parametrem -a jak√Ω se m√° pou≈æ√≠t algoritmus. Jak√© parametry lze pou≈æ√≠t se dozv√≠te pokud m√≠sto jm√©na algoritmu nap√≠≈°ete znak ?" >> /dev/stderr
 ;;
 33) NORMDIR=yes
 ;;
esac
[ $NORMDIR ] || rm -rf -- "$TEMPDIR"
exit $CHYBA
''' EXIT

TEMPDIR=$(mktemp -d -p /tmp ${NAME}-XXX) || exit 1

#=== testy z√°vislost√≠ ===
# Dependencies:
#   * feh      ( http://feh.finalrewind.org/ )
#   * exiftool ( http://www.sno.phy.queensu.ca/~phil/exiftool ) in Debian package: libimage-exiftool-perl 
#   * yad      ( http://sourceforge.net/projects/yad-dialog )
REALPATH=$(which realpath)
[ ! ${REALPATH} ] && exit 1
REALPATH="$REALPATH -e "

DIDJVU=$(which didjvu)
[ ! ${DIDJVU} ] && echo 'Nen√≠ nainstalov√°n bal√≠k didjvu, nebude mo≈æn√© aplikovat pokroƒçil√© algoritmy pro separaci pop≈ôed√≠ p≈ôi konverzi do DjVu' >> /dev/stderr && DIDJVU=false
OCRODJVU=$(which ocrodjvu)
[ ! ${OCRODJVU} ] && OCRODJVU=31
DJVIEW=$(which djview)
[ ! ${DJVIEW} ] && echo 'Nen√≠ nainstalov√°n bal√≠k djview, nebude fungovat testovac√≠ zobrazen√≠ djvu.soubor≈Ø' >> /dev/stderr && DJVIEW=false
DDJVU=$(which ddjvu)
[ ! ${DDJVU} ] && exit 20
DJVUTXT=$(which djvutxt)
[ ! ${DJVUTXT} ] && exit 20
DJVUSED=$(which djvused)
[ ! ${DJVUSED} ] && exit 20
DJVUTOXML=$(which djvutoxml)
[ ! ${DJVUTOXML} ] && exit 20
DJVUXMLPARSER=$(which djvuxmlparser)
[ ! ${DJVUXMLPARSER} ] && exit 20
DJVUDUMP=$(which djvudump)
[ ! ${DJVUDUMP} ] && exit 20
DJVMCVT=$(which djvmcvt)
[ ! ${DJVMCVT} ] && exit 20
DJVM=$(which djvm)
[ ! ${DJVM} ] && exit 20
CJB2=$(which cjb2)
[ ! ${CJB2} ] && exit 20
DJVUMAKE=$(which djvumake)
[ ! ${DJVUMAKE} ] && exit 20
#YAD=$(which yad)
#[ ! ${YAD} ] && echo 'Nen√≠ nainstalov√°n bal√≠k yad' && exit 1
MIME=$(which mimetype)
[ ! -x "${MIME}" ] && exit 21
STAT=$(which readlink)
[ ! -x "${STAT}" ] && exit 22

NETPBM=0
PNMSCALE=$(which pnmscale)
[ ! -x "${PNMSCALE}" ] && NETPBM=1
if (( $NETPBM == 0 )); then
    VERSION=($(${PNMSCALE} -version 2>&1 | head -1))
    case ${VERSION[$((${#VERSION[@]} - 1))]} in
	10.0*|9*) echo "WARNING: Version Netpbm pnmacele don't support filters. I must use imagemagick convert" >> /dev/stderr
	    NETPBM=1
	    ;;
	*)  NETPBM=0
	    BMPTOPNM=$(which bmptopnm)
	    [ ! -x "${BMPTOPNM}" ] && exit 23
	    JPEGTOPNM=$(which jpegtopnm)
	    [ ! -x "${JPEGTOPNM}" ] && exit 23
	    GIFTOPNM=$(which giftopnm)
	    [ ! -x "${GIFTOPNM}" ] && exit 23
	    PNGTOPNM=$(which pngtopnm)
	    [ ! -x "${PNGTOPNM}" ] && exit 23
	    PNMTOJPEG=$(which pnmtojpeg)
	    [ ! -x "${PNMTOJPEG}" ] && exit 23
	    TIFFTOPNM=$(which tifftopnm)
	    [ ! -x "${TIFFTOPNM}" ] && exit 23
	    PNMTOPNG=$(which pnmtopng)
	    [ ! -x "${PNMTOPNG}" ] && exit 23
	    PNMTOPLAINPNM=$(which pnmtoplainpnm)
	    [ ! -x "${PNMTOPLAINPNM}" ] && exit 23
	    PPMTOPGM=$(which ppmtopgm)
	    [ ! -x "${PPMTOPGM}" ] && exit 23
	    PGMTOPBM=$(which pgmtopbm)
	    [ ! -x "${PGMTOPBM}" ] && exit 23
	    ;;
    esac
fi
if (( $NETPBM == 1 )) ; then
    CONVERT=$(which convert)
    [ ! -x "${CONVERT}" ] && echo exit 24
fi
#=== konec testu z√°vislost√≠ ===
function exportpage {
	# $1 - svazek
	# $2 - identifik√°tor
	# $3 - c√≠l (adres√°≈ô)
	if [ ${#3} -eq "0" ] ; then
		echo "Nen√≠ target - nastav√≠m c√≠l podle lok√°ln√≠ho adres√°≈ôe" >> /dev/stderr
		TARGETDIR=$(${REALPATH} ./)
	elif [ -f "${3}" ] ; then
#		echo "Soubor. Vyt√°hnout cestu k nƒõmu.." >> /dev/stderr
		TARGET=$(${REALPATH} ${3})
		TARGETDIR=${TARGET%/*}
	elif [ -d "${3}" ] ; then
#		echo "Adres√°≈ô - pou≈æiju ho" >> /dev/stderr
		TARGETDIR=$(${REALPATH} ${3})
	else
#		echo "C√≠l - $3 mkdir -p $3" >> /dev/stderr
		mkdir -p $3
		if [ $? == "0" ] ; then
			TARGETDIR=$(${REALPATH} ${3})
		else
			echo "C√≠lov√Ω adres√°≈ô $3 nelze vytvo≈ôit"
			exit 1
		fi
	fi
	echo "C√≠l - $TARGETDIR" >> /dev/stderr
	case "$2" in
		all) # echo "export v≈°eho"
			if [ ${XML} == "yes" ] ; then
				exportxml ${1} ${TARGETDIR}
			fi
			if [ ${DSED} == "yes" ] ; then
				exportdsed ${1} ${TARGETDIR}
			fi
		;;
		*) identifypage ${1} ${2}
			NAMEPAGE=$(namepage ${1} $?)
			if [ "${NAMEPAGE}" == "" ] ; then
				echo "Neplatn√Ω identifik√°tor str√°nky $2"
				exit 1
			else
				[ ${XML} == "yes" ] && THUMBNAIL=yes
				# echo "export str√°nky $NAMEPAGE - DSED $DSED - XML $XML - THUMBNAIL $THUMBNAIL - FORCE $FORCE"
				if [ ${XML} == "yes" ] ; then
					exportxml ${1} ${2} ${TARGETDIR}
				fi
				if [ ${DSED} == "yes" ] ; then
					exportdsed ${1} ${2} ${TARGETDIR}
				fi
			fi
		;;
	esac
	exit 0
}


function exportdsed {
	# $1 - svazek
	# $2 - strana
	# $3 - adres√°≈ô
	case "${#@}" in
		3) # echo "Adres√°≈ô je p≈ôedan√Ω"
			identifypage ${1} ${2}
			PAGE=$?
			NAMEPAGE=$(namepage ${1} $PAGE)
			if [ -f "${3}/${NAMEPAGE/.djvu/.dsed}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DJVUSED} ${1} -e "select $PAGE; output-all" > ${3}/${NAMEPAGE/.djvu/.dsed}
			else
				${DJVUSED} ${1} -e "select $PAGE; output-all" > ${3}/${NAMEPAGE/.djvu/.dsed}
			fi
		;;
		2) if [ -d ${2} ] ; then
			# echo "P≈ôedan√Ω je adres√°≈ô, bude do nƒõj exportov√°n cel√Ω obsah"
			if [ -f "${2}/${1/.djvu/.dsed}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DJVUSED} ${1} -e output-all > ${2}/${1/.djvu/.dsed}
			else
				${DJVUSED} ${1} -e output-all > ${2}/${1/.djvu/.dsed}
			fi
		else
			#echo  "P≈ôedan√Ω je n√°zev str√°nky, nebo jej√≠ po≈ôad√≠, exportuje se do ./"
			identifypage ${1} ${2}
			PAGE=$?
			NAMEPAGE=$(namepage ${1} $PAGE)
			if [ -f "./${NAMEPAGE/.djvu/.dsed}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DJVUSED} ${1} -e "select $PAGE; output-all" > ./${NAMEPAGE/.djvu/.dsed}
			else
				${DJVUSED} ${1} -e "select $PAGE; output-all" > ./${NAMEPAGE/.djvu/.dsed}
			fi
		fi
		;;
		1) # echo "P≈ôedan√Ω je cel√Ω subor, exportuje se cel√Ω obsah do ./"
			if [ -f "./${1/.djvu/.dsed}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DJVUSED} ${1} -e output-all > ./${1/.djvu/.dsed}
			else
				${DJVUSED} ${1} -e output-all > ./${1/.djvu/.dsed}
			fi
		;;
		*) echo "Z nƒõjak√©ho d≈Øvodu nelze prov√©st export dsed souboru" >> /dev/stderr && exit 1
		;;
	esac
}

function exportxml {
	# $1 - svazek
	# $2 - strana
	# $3 - adres√°≈ô
	case "${#@}" in
		3) # echo "Adres√°≈ô je p≈ôedan√Ω"
			identifypage ${1} ${2}
			PAGE=$?
			NAMEPAGE=$(namepage ${1} $PAGE)
			# echo "$NAMEPAGE" >> /dev/stderr
			if [ -f "${3}/${NAMEPAGE/.djvu/.xml}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DJVUTOXML} --page ${PAGE} ${1} ${3}/${NAMEPAGE/.djvu/.xml}
			else
				${DJVUTOXML} --page ${PAGE} ${1} ${3}/${NAMEPAGE/.djvu/.xml}
				thumbnail ${1} ${PAGE} ${3}
			fi
		;;
		2) if [ -d ${2} ] ; then
			# echo "P≈ôedan√Ω je adres√°≈ô, bude do nƒõj exportov√°n cel√Ω obsah"
				if [ -f "${2}/${1/.djvu/.xml}" ] ; then
					[ "${FORCE}" == "yes" ] && ${DJVUTOXML} ${1} ${2}/${1/.djvu/.xml}
				else
					${DJVUTOXML} ${1} ${2}/${1/.djvu/.xml}
					thumbnail ${1} ${2}
				fi
			else
			# echo  "P≈ôedan√Ω je n√°zev str√°nky, nebo jej√≠ po≈ôad√≠, exportuje se do ./"
			identifypage ${1} ${2}
			PAGE=$?
			NAMEPAGE=$(namepage ${1} $PAGE)
				if [ -f "./${NAMEPAGE/.djvu/.xml}" ] ; then
					[ "${FORCE}" == "yes" ] && ${DJVUTOXML} --page ${PAGE} ${1} ./${NAMEPAGE/.djvu/.xml}
				else
					${DJVUTOXML} --page ${PAGE} ${1} ./${NAMEPAGE/.djvu/.xml}
					thumbnail ${1} ${PAGE} ./
				fi
			fi
		;;
		1) #echo "P≈ôedan√Ω je cel√Ω subor, exportuje se cel√Ω obsah do ./"
			if [ -f "./${1/.djvu/.xml}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DJVUTOXML} ${1} ./${1/.djvu/.xml}
			else
				${DJVUTOXML} ${1} ./${1/.djvu/.xml}
				thumbnail ${1} ./
			fi
		;;
		*) echo "Z nƒõjak√©ho d≈Øvodu nelze prov√©st export xml souboru" >> /dev/stderr && exit 1
		;;
	esac
}

function thumbnail {
	# Webeditor n√°hled akceptuje pouze pokud vyhovuje numerick√©mu tvaru - tedy ne tvar 001!!!
	# N√°hled se znovu exportuje pouze za p≈ôedpokladu, ≈æe je souƒçasnƒõ uvedena volba --force
	# $1 - svazek
	# $2 - adres√°≈ô nebo identifik√°tor str√°nky
	# $3 - adres√°≈ô
	case "${#@}" in
		3) # echo "P≈ôed√°n je identifik√°tor i adres√°≈ô, n√°hled str√°nky $2 se bude exportovat do $3"
			identifypage ${1} ${2}
			PAGE=$?
			NAMEPAGE=$(namepage ${1} $PAGE)
			if [ -f "${3}/${NAMEPAGE/.djvu/.png}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ${3}/${NAMEPAGE/.djvu/.png}
			else
				${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ${3}/${NAMEPAGE/.djvu/.png}
			fi
		;;
		2) if [ -d ${2} ] ; then
			# echo "P≈ôedan√Ω je adres√°≈ô, n√°hledy se budou exportovat do $2"
			lastpage ${1}
			PAGES=$?
			NUMPAGE=1
			while [ ${PAGES} -gt "0" ] ; do
				identifypage ${1} ${NUMPAGE}
				PAGE=$?
				NAMEPAGE=$(namepage ${1} $PAGE)
				if [ -f "./${NAMEPAGE/.djvu/.png}" ] ; then
					[ "${FORCE}" == "yes" ] && ${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ${2}/${NAMEPAGE/.djvu/.png}
				else
					${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ${2}/${NAMEPAGE/.djvu/.png}
				fi
				NUMPAGE=$((NUMPAGE + 1))
				PAGES=$((PAGES - 1))
			done
		else
			# echo  "P≈ôedan√Ω je identifik√°tor str√°nky, n√°hled se exportuje do ./"
			identifypage ${1} ${2}
			PAGE=$?
			NAMEPAGE=$(namepage ${1} $PAGE)
			if [ -f "./${NAMEPAGE/.djvu/.png}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ./${NAMEPAGE/.djvu/.png}
			else
				${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ./${NAMEPAGE/.djvu/.png}
			fi
		fi
		;;
		1) # echo "P≈ôedan√Ω je cel√Ω subor $1, n√°hledy str√°nek se ukl√°daj√≠ do ./"
			lastpage ${1}
			PAGES=$?
			NUMPAGE=1
			while [ ${PAGES} -gt "0" ] ; do
				identifypage ${1} ${NUMPAGE}
				PAGE=$?
				NAMEPAGE=$(namepage ${1} $PAGE)
				if [ -f "./${NAMEPAGE/.djvu/.png}" ] ; then
					[ "${FORCE}" == "yes" ] && ${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ./${NAMEPAGE/.djvu/.png}
				else
					${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ./${NAMEPAGE/.djvu/.png}
				fi
				NUMPAGE=$((NUMPAGE + 1))
				PAGES=$((PAGES - 1))
			done
		;;
		*) echo "Z nƒõjak√©ho d≈Øvodu nelze prov√©st export n√°hledov√Ωch soubor≈Ø" >> /dev/stderr && exit 1
		;;
	esac
}

function inserttext {
	if [ -f ${1/.djvu/.xml} ] ; then
		${DJVUXMLPARSER} -o ${1} ${1/.djvu/.xml}
	elif [ -f ${1/.djvu/.dsed} ] ; then
		${DJVUSED} ${1} -f ${1/.djvu/.dsed} -s
	fi
}

function insertxmp {
	if [ -f ${1/.djvu/.xmp} ] ; then
		echo "Vkl√°d√°m xmp informace, pokud jsou.."
	fi
}

function konvertor {
	# $1 - vstup
	# $2 - v√Ωstup
	# je-li na vstupu djvu provede pouze operace spojen√© s vyexportov√°n√≠m XML, DSED a n√°hledu v png
	# je-li na vstupu nƒõco jin√©ho ne≈æ png, djvu, dsed, xml, mng, tiff, xcf ƒçi pdf  ovƒõ≈ô√≠ zda-li jde o obr√°zek
	if [ -f "$1" ] ; then
		if [ "${1##*.}" == "djvu" ] ; then
			FROM="$1"
		else
			# konverze a v√Ωsledek bude ve from..
			# SEPARATE - rozdƒõlen√≠ na vrstvy  yes (default) | no
			# DPI - 300 (default)
			# ALG
			todjvu "$1" "$2"
			if [ "$?" !=  "0" ]  ; then
				exit 40
			fi
		fi
		if [ -f "$2" ] && [ "${TEST}" != "yes" ]; then
			if [ ${DSED} == "yes" ] ; then
				if [ -f "${2/.djvu/.dsed}" ] ; then
					if [ ${FORCE} != "no" ] ; then
						rm ${2/.djvu/.dsed}
						exportdsed ${2}
					fi
				else
					exportdsed ${2}
				fi
			fi
			if [ ${XML} == "yes" ] ; then
				THUMBNAIL=yes
				if [ -f "${2/.djvu/.xml}" ] ; then
					if [ ${FORCE} != "no" ] ; then
						# exportuji textovou vrstvu v xml, pouze pokud neexistuje, nebo je-li uveden parametr -f (--force)
						# XML ve v√Ωchoz√≠m stavu exportuje jak text tak hyperlinky. Neexportuje v≈°echna metadata!!!
						rm ${2/.djvu/.xml}
						exportxml ${2}
					fi
				else
					exportxml ${2}
				fi
			fi
			if [ ${THUMBNAIL} == "yes" ] ; then
				thumbnail ${2}
			fi
			if [ ${INSERTTEXT} == "yes" ] && [ ${#OCR} != "3" ] ; then
				inserttext ${2}
			elif [ ! ${OCR} ] ; then
				inserttext ${2}
			fi
		fi
	fi
}

function getocr {
	# $1 - jm√©no djvu souboru 
	if [ "${OCR}" ] ; then
		[ "${OCRODJVU%%+([0-9])}" == "" ] && exit ${OCRODJVU} || ${OCRODJVU} --in-place -l ${OCR} "$1"
	fi
}

function identifypage {
	# Funkce vrac√≠ po≈ôadov√© ƒç√≠slo str√°nky
	# $1 soubor
	# $2 testovan√° hodnota
	if [ "${2%%+([0-9])}" == "" ] ; then
		PAGE="\[P$2\]"
	else
		PAGE="\{$2\}"
	fi
#	echo "$PAGE" >> /dev/stderr
	OUTPUT=($(${DJVUDUMP} ${1} | grep FORM | grep $PAGE))
	echo ${OUTPUT[@]} >> /dev/null
	return ${OUTPUT[3]//+([\]P\[])/}
}

function namepage {
	# Funkce vrac√≠ jm√©no str√°nky na z√°kladƒõ po≈ôadov√©ho ƒç√≠sla str√°nky
	# $1 soubor
	# $2 ƒç√≠slo str√°nky
	if [ "${2%%+([0-9])}" == "" ] ; then
		PAGE="\[P$2\]"
		OUTPUT=($(${DJVUDUMP} ${1} | grep FORM | grep $PAGE))
#		echo ${OUTPUT[@]} >> /dev/stderr
		echo ${OUTPUT[2]//+([\{\}])/}
	else
		return 1
	fi
}

function lastpage {
	# Funkce vrac√≠ ƒç√≠slo posledn√≠ str√°nky
	# $1 jm√©no v√≠cestr√°nkov√©ho djvu souboru
	OUTPUT=($(${DJVUDUMP} ${1} | grep FORM | tail -1))
	return ${OUTPUT[3]//+([\]P\[])/}
}

function insertpage {
	# $1 - soubor se kter√Ωm se pracuje
	# $2 - djvu soubor co se m√° vlo≈æit
	# $3 - identifik√°tor str√°nky p≈ôed kterou se m√° vlo≈æit
	identifypage ${1} ${3}
	PAGE=$?
#	echo $PAGE
	if [ ${PAGE} -gt "0" ] ; then
		${DJVM} -i $1 $2 $PAGE
	else
		${DJVM} -i $1 $2
	fi
}

function deletepage {
	# $1 - soubor se kter√Ωm se pracuje
	# $2 - ƒç√≠slo, nebo n√°zev strany co se m√° odstranit
	identifypage ${1} ${2}
	PAGE=$?
#	echo $PAGE
	if [ ${PAGE} -gt "0" ] ; then
		echo "Odstra≈àuji str√°nku $2"
		${DJVM} -d $1 $PAGE
	else
		echo "Str√°nka $2 v souboru nen√≠. Nezapome≈àte, ≈æe konvertovan√©mu souboru se mƒõn√≠ p≈ô√≠pona!!"
		exit 1
	fi
}

function rotatepage {
	# $1 - soubor se kter√Ωm se pracuje
	# $2 - ƒç√≠slo, nebo n√°zev strany kter√° se m√° rotovat
	# $3 - hodnota rotace
	identifypage ${1} ${2}
	PAGE=$?
#	echo $PAGE
	if [ ${PAGE} -gt "0" ] ; then
#		echo "Ot√°ƒç√≠m str√°nku $2 o $3" >> /dev/stderr
		[ "$3" == "" ] && echo "Je t≈ôeba parametrem urƒçit natoƒçen√≠ str√°nky, nebo alespo≈à smƒõr rotace. P≈ôi uveden√≠ smƒõru rotace se str√°nka pootoƒç√≠ o 90¬∞" && exit 0
		echo "${DJVUSED} -e \'select $PAGE; set-rotation $3; save\' $1" >> /dev/stderr
		case "$3" in
			0|1|2|3)  ${DJVUSED} -e "select $PAGE; set-rotation $3; save" $1
			;;
			left) ${DJVUSED} -e "select $PAGE; set-rotation +1; save" $1
			;;
			right) ${DJVUSED} -e "select $PAGE; set-rotation -1" $1
			;;
			180) ${DJVUSED} -e "select $PAGE; set-rotation +2" $1
			;;
			*) echo "Rotace akceptuje absolutn√≠ hodnoty 0, 1 (vpravo), 2 (vzh≈Øru nohama), 3 (vlevo) a left (pro ot√°ƒçen√≠ str√°nky o 90¬∞ smƒõrem doleva) a right (pro ot√°ƒçen√≠ str√°nky o 90¬∞ smƒõrem doprava). Ka≈æd√° jin√° hodnota parametru vede k tomu, ≈æe je rotace ignorov√°na."
			;;
		esac
	else
		echo "Str√°nka $2 v souboru nen√≠. Nezapome≈àte, ≈æe u konvertovan√©ho souboru se mƒõn√≠ p≈ô√≠pona!!"
		exit 1
	fi
}

function forwardpage {
	# $1 - soubor
	# $2 - str√°nka k p≈ôesunu
	# $3 - pozice k p≈ôesunu
	echo "p≈ôed" >> /dev/stderr
	identifypage $1 $2
	AORDER=$?
	A=$(namepage $1 $AORDER)
	B=$(namepage $1 $3)
	echo "P≈ôesouv√°m $A p≈ôed $B"
	[ "$A" == "$3" ] && echo "Soubor k p≈ôesunu se ji≈æ nach√°z√≠ na p≈ôedan√© pozici" > /dev/stderr && exit 37
	${DJVMCVT} -i ${1} ${TEMPDIR} index.djvu
	# Rozbaleno.. mohu zaƒç√≠t mazat..
	deletepage ${1} ${AORDER}
	if [ "${3}" == "" ] ; then
		echo "P≈ôesouv√°m $2 o str√°nku vp≈ôed.."
		if [ ${AORDER} == "1" ] ; then
			insertpage ${1} "${TEMPDIR}/${A}" $AORDER
		else
			insertpage ${1} "${TEMPDIR}/${A}" $((AORDER-1))
		fi
	else
		# Nejprve mus√≠m zjistit aktu√°ln√≠ pozici B
		identifypage $1 $B
		BORDER=$?
		if [ ${#B} -eq "0" ] ; then
			echo "Vkl√°d√°m str√°nku $A na p≈Øvodn√≠ pozici, proto≈æe p≈ôedan√Ω indentifikaƒçn√≠ parametr nov√© pozice je neplatn√Ω" >> /dev/stderr
			insertpage ${1} "${TEMPDIR}/${A}" $AORDER
		else
			# A pak mohu zaƒç√≠t vkl√°dat..
#			if [ ${BORDER} == "1" ] ; then
#				insertpage ${1} "${TEMPDIR}/${A}" $AORDER
#			else
				insertpage ${1} "${TEMPDIR}/${A}" $BORDER
#			fi
#			echo "Mohu zaƒç√≠t vkl√°dat" >> /dev/stderr
#			insertpage ${1} "${TEMPDIR}/${A}" $BORDER
		fi
	fi
	exit 33
}

function backpage {
	# $1 - soubor
	# $2 - str√°nka k p≈ôesunu
	# $3 - pozice k p≈ôesunu
	identifypage $1 $2
	AORDER=$?
	A=$(namepage $1 $AORDER)
	B=$(namepage $1 $3)
#	[ "$A" == "$3" ] && echo "Soubor k p≈ôesunu se ji≈æ nach√°z√≠ na p≈ôedan√© pozici" > /dev/stderr && exit 37
	${DJVMCVT} -i ${1} ${TEMPDIR} index.djvu
	deletepage ${1} ${AORDER}
	if [ "${3}" == "" ] ; then
		insertpage ${1} "${TEMPDIR}/${A}" $((AORDER+1))
	else
		identifypage $1 $B
		BORDER=$?
		if [ ${#B} -eq "0" ] ; then
			insertpage ${1} "${TEMPDIR}/${A}" $AORDER
		else
			insertpage ${1} "${TEMPDIR}/${A}" $((BORDER+1))
		fi
	fi
}

function movepage {
	# Kdy≈æ sma≈æu 25, odstran√≠ ve skuteƒçnosti p≈ôedchoz√≠ pozici.. (24)
	# a kdy≈æ vlo≈æ√≠m na pozici 25, tak ho stuteƒçnƒõ vlo≈æ√≠, ale st√°vaj√≠c√≠ soubor odsune a≈æ za...
	# tak≈æe...
	# m√°-li stranu 3 d√°t p≈ôed stranu 7...
	# 1, rozbal√≠...
	# 2, odstran√≠ stranu (3 - 1) tedy pozici 2...
	# 3, vyhled√° pozici strany 7 (ta se mezi t√≠m p≈ôesunula na pozici 6)
	# 4, vlo≈æ√≠ soubor, kter√Ω byl p≈Øvodnƒõ na pozici 3 na pozici 6
	# to je p≈ôesun before...
	# ...
	# P≈ôesun after..
	# 1, - 3, je stejn√©
	# 4, jeliko≈æ je strana 7 nyn√≠ na pozici 6 a m√° p≈ôedch√°zet vlo≈æen√© str√°nce, je t≈ôeba...
	# 5, vlo≈æit soubor, kter√Ω byl p≈Øvodnƒõ na pozici 3 na pozici 7 ...
	# $1 vstupn√≠ soubor
	# $2 str√°nka p≈ôesouvan√°
	# $3 str√°nka c√≠lov√°
	echo "Funkce movepage.."
	# Ze $1 udƒõlat indirect do adres√°≈ôe temporar
	# vyt√°hnout jm√©na soubor≈Ø 
	namepage $1 $2
	namepage $1 $3
	# ${DJVM} -d $1 $2
	# identifypage $1 $NAMETARGET
	# NUMTARGET=$?
	# ${DJVM} -i $1 temporar/$INSERT $NUMTARGET
}

function djvubundle {
	# Funkce pro vytvo≈ôen√≠ svazku..
	# $1 - vzorek podle kter√©ho se maj√≠ vybrat soubory
	# $2 - c√≠lov√Ω DjVu soubor
	# $FORCE - ovliv≈àuje jestli se m√° p≈ôepsat c√≠lov√Ω soubor, nebo ne
	# $INDIRECT - ovliv≈àuje typ svazku
	# $SUFFIX - je p≈ô√≠pona v√Ωchoz√≠ch soubor≈Ø
	echo $@
	if [ -f "$1" ] ; then
		if [ -f "$2" ] ; then 
			if [ ${FORCE} == "no" ] ; then
				echo "pou≈æiju djvmcvt"
				help existed "$2"
				exit 0
			else
				${DJVMCVT} -${INDIRECT} "$1" "$2"
			fi
		fi
	else
		if [ -f "$2" ] ; then 
			if [ ${FORCE} == "no" ] ; then
				help existed "$2"
				exit 0
			else
				rm -rf "$2"
			fi
		fi
		if [ ${RENAME} == "no" ] ; then
			echo "V√Ωchoz√≠ soubory jsou identifikov√°ny vzorkem a nep≈ôejmenuj√≠ se"
			for i in $(ls -1 | grep -E "([0-9])\1?$SUFFIX\$" | sed "s/$1//" | sort -n) ; do
				#echo "$2 $1$i"
				ORIGSOUBOR="$1$i"
				DJVUSOUBOR=${ORIGSOUBOR/$SUFFIX/.djvu}
				if [ -f "$ORIGSOUBOR" ] ; then
					if [ ! -f "$DJVUSOUBOR" ] ; then
						todjvu "$ORIGSOUBOR"
					fi
				fi
				if [ -f "$2" ] ; then
					${DJVM} -i "$2" "$DJVUSOUBOR"
				else
					${DJVM} -c "$2" "$DJVUSOUBOR"
				fi
			done 
		else
#		RENAME
			if [ "${RENAME}" == "0" ] ; then
				#echo "numerick√© ƒç√≠slov√°n√≠, n√°zev soubor≈Ø se - a≈æ na ƒç√≠slo zachov√° "
				INPUT=""
					for i in $(ls -1 $1*${SUFFIX} ) ; do
						if [ "$INPUT" == "" ] ; then
							INPUT="${i%%+([0-9${SUFFIX}.])}"
						elif [ "$INPUT" != "${i%%+([0-9${SUFFIX}.])}" ] ; then
							continue
						else
							echo "zpracuji $i" > /dev/null
						fi
						STRING="${i#${INPUT}}"
						RAWNUMBER="${STRING%${SUFFIX}}"
						NUMBER="${RAWNUMBER##+(0)}"
						if [ "${NUMBER}" == "" ] ; then
							TARGET="${INPUT}0${SUFFIX}"
						else
							TARGET="${INPUT}${NUMBER}${SUFFIX}"
						fi
						if [ "$3" ] ; then
							if [ "$TARGET" == "${VZOR}$3${SUFFIX}" ] ; then
								konvertor "$i" "${TARGET/${SUFFIX}/.djvu}"
							fi
						else
							konvertor "$i" "${TARGET/${SUFFIX}/.djvu}"
						fi
					done
#					echo "NUMERIC - soubor stejn√Ω"
			elif [ ! "${RENAME//0/}" ] ; then
				MAX="0"
					for i in $(ls -1 $1*${SUFFIX} ) ; do
						if [ "$INPUT" == "" ] ; then
							INPUT="${i%%+([0-9${SUFFIX}.])}"
						elif [ "$INPUT" != "${i%%+([0-9${SUFFIX}.])}" ] ; then
							continue
						else
							echo "zpracuji $i" > /dev/null
						fi
						STRING="${i#${INPUT}}"
						RAWNUMBER="${STRING%${SUFFIX}}"
						if [ "${#RAWNUMBER}" -gt  "${#MAX}" ] ; then
							MAX="${RAWNUMBER}"
						fi
					done
				if [ "${#MAX}" -gt "${#RENAME}" ] ; then
					BASE="${MAX//[0-9]/0}"
				else
					BASE="${RENAME}"
				fi
				INPUT=""
					for i in $(ls -1 $1*${SUFFIX} ) ; do
						if [ "$INPUT" == "" ] ; then
							INPUT="${i%%+([0-9${SUFFIX}.])}"
						elif [ "$INPUT" != "${i%%+([0-9${SUFFIX}.])}" ] ; then
							continue
						else
							echo "zpracuji $i" > /dev/null
						fi
						STRING="${i#${INPUT}}"
						RAWNUMBER="${STRING%${SUFFIX}}"
						NUMBER="${RAWNUMBER##+(0)}"
						if [ "${NUMBER}" == "" ] ; then
							TARGET="${INPUT}${BASE}${SUFFIX}"
						else
							TARGET="${INPUT}${BASE:0:$((${#BASE} - ${#NUMBER}))}${NUMBER}${SUFFIX}"
						fi
						if [ "$3" ] ; then
							if [ "$TARGET" == "${VZOR}$3${SUFFIX}" ] ; then
								konvertor "$i" "${TARGET/${SUFFIX}/.djvu}"
							fi
						else
							konvertor "$i" "${TARGET/${SUFFIX}/.djvu}"
						fi
					done
#				echo "BASE - soubor stejn√Ω"
			else
				# VZOR + BASE z RENAME
				VZOR="${RENAME%%+(0)}"
				BASE="${RENAME#$VZOR}"
				if [ "${#BASE}" == "1" ] ; then
					INPUT=""
					for i in $(ls -1 $1*${SUFFIX} ) ; do
						if [ "$INPUT" == "" ] ; then
							INPUT="${i%%+([0-9${SUFFIX}.])}"
						elif [ "$INPUT" != "${i%%+([0-9${SUFFIX}.])}" ] ; then
							continue
						else
							echo "zpracuji $i" > /dev/null
						fi
						STRING="${i#${INPUT}}"
						RAWNUMBER="${STRING%${SUFFIX}}"
						NUMBER="${RAWNUMBER##+(0)}"
						if [ "${NUMBER}" == "" ] ; then
							TARGET="${VZOR}0${SUFFIX}"
						else
							TARGET="${VZOR}${NUMBER}${SUFFIX}"
						fi
						if [ "$3" ] ; then
							if [ "$TARGET" == "${VZOR}$3${SUFFIX}" ] ; then
								konvertor "$i" "${TARGET/${SUFFIX}/.djvu}"
							fi
						else
							konvertor "$i" "${TARGET/${SUFFIX}/.djvu}"
						fi
					done
#					echo "NUMERIC - vzor"
				else
					INPUT=""
					MAX="0"
					for i in $(ls -1 $1*${SUFFIX} ) ; do
						if [ "$INPUT" == "" ] ; then
							INPUT="${i%%+([0-9${SUFFIX}.])}"
						elif [ "$INPUT" != "${i%%+([0-9${SUFFIX}.])}" ] ; then
							echo "Soubor $i nevyhovuje zvolen√©mu vzoru $1 p≈ôeskakuji jej" >> /dev/stderr
							continue
						else
							echo "zpracuji $i" > /dev/null
						fi
						STRING="${i#${INPUT}}"
						RAWNUMBER="${STRING%${SUFFIX}}"
						if [ "${#RAWNUMBER}" -gt  "${#MAX}" ] ; then
							MAX="${RAWNUMBER}"
						fi
					done
					ORIGBASE="${MAX//[0-9]/0}"
					if [ "${#ORIGBASE}" -gt "${#BASE}" ] ; then
						BASE="$ORIGBASE"
						echo "ORIGBASE - vzor"
					fi
					#	Seznam set≈ô√≠dƒõn√Ω podle d√©lky ≈ôetƒõzc≈Ø $(ls -1 $1* | grep -E "([0-9])\1?$SUFFIX\$" | sed "s/$1//" | sort -n)
					# for i in $(ls -1 | grep -E "([0-9])\1?$SUFFIX\$" | awk '{ print length, $0 }' | sort -n ) ; do
					INPUT=""
					for i in $(ls -1 $1*${SUFFIX} ) ; do
						if [ "$INPUT" == "" ] ; then
							INPUT="${i%%+([0-9${SUFFIX}.])}"
						elif [ "$INPUT" != "${i%%+([0-9${SUFFIX}.])}" ] ; then
							continue
						else
							echo "zpracuji $i" > /dev/null
						fi
						STRING="${i#${INPUT}}"
						RAWNUMBER="${STRING%${SUFFIX}}"
						NUMBER="${RAWNUMBER##+(0)}"
						if [ "${NUMBER}" == "" ] ; then
							TARGET="${VZOR}${BASE}${SUFFIX}"
						else
							TARGET="${VZOR}${BASE:0:$((${#BASE} - ${#NUMBER}))}${NUMBER}${SUFFIX}"
						fi
						if [ "$3" ] ; then
							if [ "$TARGET" == "${VZOR}$3${SUFFIX}" ] ; then
								konvertor "$i" "${TARGET/${SUFFIX}/.djvu}"
							fi
						else
							konvertor "$i" "${TARGET/${SUFFIX}/.djvu}"
						fi
					done
#					echo "VZOR BASE"
				fi
			fi
		fi
	fi
}

function fromxcf {
	if [ "${1##*.}" == "xcf" ] ; then
		TEMPORARY="/tmp/$WINDOWID$BASHPID"
		mkdir $TEMPORARY
		convert ${1} ${TEMPORARY}/test.png
		pushd $TEMPORARY
			BUNDLE=" "
			for i in $(ls -cr -1) ; do
				todjvu $i
				BUNDLE="$BUNDLE ${i/.png/.djvu}"
			done
			djvm -c out.djvu $BUNDLE
		popd
		mv $TEMPORARY/out.djvu ./
		rm -rf $TEMPORARY
	fi
}

function help {
	echo """[1mN√°povƒõda pro [1m[2m${0##*/}[0m :"""
	case "$1" in
		indirect) echo"""
[1mVolba[0m
         --indirect Volba, kterou lze zmƒõnit v√Ωchoz√≠ typ v√≠cestr√°nkov√©ho 
                    DjVu svazku (bundeled)

  Volbu je t≈ôeba aplikovat pokud chcete rozbalit stv√°vaj√≠c√≠ DjVu svazek 
  do podoby voln√©ho svazku, nebo pokud chcete p≈ôi konverzi bitmapov√Ωch
  soubor≈Ø rovnou sestavit DjVu svazek jako voln√Ω

  V√Ωhodou voln√©ho svazku je, ≈æe lze dodateƒçnƒõ upravovat jednotliv√© str√°nky
  jako samostatn√© DjVu soubory, ani≈æ by je bylo nutn√© exportovat.

  Pro finalizaci DjVu svazku je pak lep≈°√≠ svazek p≈ôekonvertovat na typ
  bundled, kdy je v≈°e zabaleno v jednom souboru
"""
		;;
		existed) echo """
  Soubor $2 existuje. Pokud se m√° p≈ôepsat, mus√≠ b√Ωt
  uveden parametr -f (--force)
"""
		;;
		dpi) echo"""
[1mParametr[0m
         --dpi  <[2mƒç√≠slo[22m> Hodnota DPI, kter√° se m√° pou≈æ√≠t p≈ôi zpracov√°n√≠ obr√°zku.
                               p≈ôi konverzi. Optim√°ln√≠ je zjistit hodnotu p≈ô√≠mo ze vstupn√≠ho
                               obr√°zku. P≈ôed nastaven√≠m t√©to hodnoty pro fin√°ln√≠ konverzi. lze vyzkou≈°et
                               optim√°ln√≠ nastaven√≠ na nƒõkter√©m ze soubor≈Ø s vyu≈æit√≠m parametru
                               --test

  Rozsah ƒç√≠seln√© hodnoty je od 72 do 6000 dpi. V√Ωchoz√≠ hodnota 300 se pou≈æije 
  v p≈ô√≠padƒõ, ≈æe parametr --dpi nen√≠ v≈Øbec uveden.
  Vliv dpi na zpracov√°n√≠ obrazu..
"""
		;;
		level) echo"""
[1mParametr[0m
         -l|--level  <[2mƒç√≠slo[22m> Hodnota akceptovateln√Ωch ztr√°t u ƒçernob√≠l√© kresby
                               p≈ôi konverzi. P≈ôed nastaven√≠m t√©to hodnoty vyzkou≈°ejte
                               optim√°ln√≠ nastaven√≠ na nƒõkter√©m ze soubor≈Ø a s parametrem
                               --test

  Kromƒõ ƒç√≠seln√© hodnoty, kter√° mus√≠ b√Ωt men≈°√≠ ne≈æ 200 lze √∫rove≈à ztr√°t
  nastavit i pomoc√≠ nƒõkter√©ho z n√°sleduj√≠c√≠ch parametr≈Ø - v p≈ô√≠padƒõ ≈æe 
  jich bude uvedeno v√≠c, m√° prioritu posledn√≠ z nich.

        --lossless     0 - ≈æ√°dn√© ztr√°ty (default)
        --clean        1 - ignoruj√≠ se body o velikosti 1 pixelu
        --lossy        100 - ignoruj√≠ se plochy
"""
		;;
		keywords-set) echo """
  <svazek> set <key> ... - Do metainformac√≠ Djvu svazku vlo≈æ√≠ kl√≠ƒç s p≈ô√≠slu≈°n√Ωm obsahem

P≈ô√≠klad:
   svazek.djvu set author 'John Doe'
[1mPou≈æit√≠[0m

  [1m${0##*/}[0m [volby] <svazek> insert <file> [<num>|<name>]

         num  - po≈ôadov√© ƒç√≠slo str√°nky
         name - jm√©no str√°nky
         file - jm√©no DjVu str√°nky, nebo skenu
"""
		;;
		keywords-print) echo """
  <svazek> print [[<num>|<name>] <key>] Vyp√≠≈°e obsah kl√≠ƒçe z metainformac√≠ Djvu svazku. Bez kl√≠ƒçov√©ho slova vyp√≠≈°e v≈°echny

P≈ô√≠klad:
   svazek.djvu print author
[1mPou≈æit√≠[0m

  [1m${0##*/}[0m [volby] <svazek> insert <file> [<num>|<name>]

         num  - po≈ôadov√© ƒç√≠slo str√°nky
         name - jm√©no str√°nky
         file - jm√©no DjVu str√°nky, nebo skenu
"""
		;;
		keywords-rotate) echo """
  <svazek> rotate {<num>|<name>} [<key>] Otoƒçen√≠ str√°nky Djvu svazku.

P≈ô√≠klad:
   svazek.djvu rotate 1 left
[1mPou≈æit√≠[0m

  [1m${0##*/}[0m [volby] <svazek> insert <file> [<num>|<name>]

         num  - po≈ôadov√© ƒç√≠slo str√°nky
         name - jm√©no str√°nky
         file - jm√©no DjVu str√°nky, nebo skenu
"""
		;;
		keywords-export) echo """vytvo≈ôen√≠ xml, dsed a n√°hledu
  Export n√°hledu a textov√©ho obsahu DjVu souboru do extern√≠ch soubor≈Ø.

[1mSyntaxe[0m

  [1m${0##*/}[0m [volby] <svazek> export {<num>|<name>|all} [<dir>]

         num  - po≈ôadov√© ƒç√≠slo str√°nky v DjVu svazku
         name - jm√©no str√°nky v DjVu svazku
         dir  - adres√°≈ô do kter√©ho m√° b√Ωt v√Ωstup ulo≈æen

[3mPozn√°mka:[23m
  Je-li m√≠sto po≈ôadov√©ho ƒç√≠sla str√°nky, nebo jej√≠ho n√°zvu, uvedeno all tak
  se bude exportovat obsah textov√Ωch vrstev cel√©ho DjVu svazku.
  Form√°t exportovan√©ho souboru je ve v√Ωchoz√≠m stavu .xml, ale s vyu≈æit√≠m 
  volby -d (--dsed) lze textovou vrstvu exportovat i ve form√°tu pro djvused.
  Je-li uveden tak√© parametr --thumb, bude vyexportov√°n i n√°hled v .png
  Nen√≠-li uveden adres√°≈ô, je pou≈æit aktu√°ln√≠ adres√°≈ô. Pro pojmenov√°n√≠ soubor≈Ø
  je vyu≈æit n√°zev str√°nky v takov√© podobƒõ, jak je ulo≈æen v DjVu svazku.
  Pokud ji≈æ soubory se stejn√Ωm n√°zvem v adres√°≈ôi existuj√≠, lze si vynutit
  jejich p≈ôeps√°n√≠ volbou -f (--force)
"""
		;;
		keywords-import) echo """
  Import textov√©ho obsahu DjVu souboru z extern√≠ch soubor≈Ø

[1mSyntaxe[0m

  [1m${0##*/}[0m [volby] <svazek> import <file> [<num>|<name>]

         num  - po≈ôadov√© ƒç√≠slo str√°nky v DjVu svazku
         name - jm√©no str√°nky v DjVu svazku
         file - soubor s obsahem skryt√© textov√© vrstvy

[3mPozn√°mka:[23m
  Nen√≠-li uvedeno po≈ôadov√© ƒç√≠slo str√°nky, nebo jej√≠ n√°zev, tak se p≈ôedpokl√°d√°
  ≈æe jde o obsah textov√© vrstvy cel√©ho DjVu svazku.
  Soubor je rozli≈°en√Ω podle p≈ô√≠pony a m≈Ø≈æe to b√Ωt buƒè v .dsed nebo .xml
  form√°tu.
  Touto cestou lze importovat tak√© XMP informace z .xmp souboru
"""
		;;
		keywords-delete) echo """
  Odstranƒõn√≠ str√°nky z DjVu svazku

[1mSyntaxe[0m

  [1m${0##*/}[0m [volby] <svazek> delete {<num>|<name>}

         num  - po≈ôadov√© ƒç√≠slo str√°nky v DjVu svazku
         name - jm√©no str√°nky v DjVu svazku
"""
		;;
		keywords-insert) echo """
  Vlo≈æen√≠ nov√© str√°nky do Djvu svazku. Je-li na vstupu nekonvertovovan√Ω
  obr√°zek, dojde ke konverzi. Nen√≠-li uvedeno po≈ôadov√© ƒç√≠slo, nebo n√°zev
  str√°nky p≈ôed kterou se m√° str√°nka vlo≈æit, je p≈ôipojena na konec DjVu svazku

[1mSyntaxe[0m

  [1m${0##*/}[0m [volby] <svazek> insert <file> [<num>|<name>]

         num  - po≈ôadov√© ƒç√≠slo str√°nky v DjVu svazku
         name - jm√©no str√°nky v DjVu svazku
         file - jm√©no DjVu str√°nky, nebo skenu

  POZOR: Pokud se ji≈æ v DjVu souboru str√°nka se stejn√Ωm n√°zvem vyskytuje,
         Dojde p≈ôi vlo≈æen√≠ k p≈ôejmenov√°n√≠ souboru - za n√°zev se p≈ôid√°
         podtr≈æ√≠tko a po≈ôadov√© ƒç√≠slo v√Ωskytu.
         K takov√© situaci m≈Ø≈æe doj√≠t tak√© v p≈ô√≠padƒõ, ≈æe je operace insert
         zopakov√°na se stejn√Ωmi parametry. Pak se p≈ôidan√© ƒç√≠slo postupnƒõ
         zvy≈°uje. Takto:

              insert test01.jpg => test01.djvu
              insert test01.jpg => test01_1.djvu
              insert test01.jpg => test01_2.djvu
              ...
"""
		;;
		keywords-forward) echo """
  <svazek> forward {<num>|<name>} [<num>|<name>] - p≈ôi t√©to akci se str√°nka v DjVu
          svazku, identifikovan√° pozic√≠ (<num>) nebo n√°zvem (<name>) p≈ôesune
          p≈ôed str√°nku, kter√° j√≠ p≈ôedch√°z√≠.
          V p≈ô√≠padƒõ, ≈æe jde o prvn√≠ str√°nku DjVu svazku se nestane nic.
          M√°-li se p≈ôesunout p≈ôed jinou, ne≈æ p≈ôedchoz√≠ str√°nku, pak mus√≠ b√Ωt
          uvedeno jako dal≈°√≠ parametr po≈ôadov√© ƒç√≠slo, nebo n√°zev t√©to str√°nky
"""
		;;
		keywords-back) echo """
  <svazek>  back {<num>|<name>} [<num>|<name>] - p≈ôi t√©to akci se str√°nka v v r√°mci DjVu
          svazku identifikovan√° pozic√≠ (<num>) nebo n√°zvem (<name>) p≈ôesune
          za str√°nku, kter√° j√≠ p≈ôedch√°z√≠.
          V p≈ô√≠padƒõ, ≈æe jde o posledn√≠ str√°nku DjVu svazku se nestane nic.
          M√°-li se p≈ôesunout p≈ôed jinou str√°nku, ne≈æ tu kter√° ji n√°sleduje
          pak mus√≠ b√Ωt uvedeno jako dal≈°√≠ parametr po≈ôadov√© ƒç√≠slo, nebo
          n√°zev str√°nky, za kterou se m√° p≈ôesunout.
"""
		;;
		keywords) echo """
  [1m${0##*/}[0m [volby] {DjVu svazek} <keyword> [-h|...]

  [1m      keyword - popis akce[0m

         delete - odstran√≠ str√°nku ze svazku
         insert - vlo≈æ√≠ novou str√°nku do svazku
  forward, back - p≈ôesune str√°nku v r√°mci svazku
         rotate - mƒõn√≠ orientaci vybran√© str√°nky
            set - nastavuje metainformace DjVu str√°nek a svazku
          print - vypisuje metainformace z DjVu str√°nek a svazku
         export - exportuje djvu str√°nku, dsed nebo xml soubor s obsahem
                  textov√© vrstvy, n√°hled str√°nky v png, atp.
         import - importuje do DjVu str√°nky ƒçi svazku obsah skryt√© textov√©
                  vrstvy z xml str√°nky

[2mPozn√°mka:[0m Pro podrobnƒõj≈°√≠ n√°povƒõdu uveƒète za kl√≠ƒçov√Ωm slovem -h 
"""
		;;
		rename) echo """
[1mParametr[0m
         -r|--rename  <[2mvzor[22m>  Vzor, podle jak√©ho se maj√≠ p≈ôejmenovat
                              d√≠lƒç√≠ DjVu soubory, ze kter√Ωch se pak bude
                              sestavovat DjVu svazek.
[4mPopis:[24m
  Pomoc√≠ [2mvzoru[22m lze upravit n√°zvy zkonvertovan√Ωch DjVu soubor≈Ø
  p≈ôed jejich sestaven√≠m do DjVu svazku. [2mVzor[22m m≈Ø≈æe b√Ωt tvo≈ôen:
    1, Pouze jednou, nebo v√≠ce nulami - 000
    2, Nebo ≈ôetƒõzcem, n√°sledovan√Ωm nulami - soubor_00

[3mPozn√°mka:[23m
  Je-li uvedena pouze jedna nula, budou str√°nky oƒç√≠slov√°ny [4mnumericky[24m,
  t.j. od ƒç√≠sla 1 d√°le. Je-li nul v√≠ce, pak bude ƒç√≠slo interpretov√°no
  jako [4m≈ôetƒõzec[24m. tedy 001 a d√°le. Pokud by ƒç√≠slov√°n√≠ str√°nek p≈ôes√°hlo
  nastaven√Ω poƒçet ƒç√≠sel, bude upraven dle maxim√°ln√≠ho ƒç√≠sla.

[3mUk√°zkov√© vzory : a v√Ωsledn√Ω efekt..[23m
   soubor-0000 : soubor-0001.djvu .. soubor-0123.djvu
   soubor_0    : soubor_1.djvu    .. soubor_123.djvu
   soubor000   : soubor0001.djvu  .. soubor1234.djvu
"""
			;;
		suffix) echo """
[1mParametr[0m
         -s|--suffix  <[2msuffix[22m>  P≈ô√≠pona soubor≈Ø, ze kter√Ωch se m√° sestavit 
                                DjVu soubor.
[4mPopis:[24m
  [2mSuffix[22m je nutn√© uv√©st pouze v p≈ô√≠padƒõ, ≈æe soubory s n√°zvem odpov√≠daj√≠c√≠m
  vzorku dosud nebyly do DjVu zkonvertov√°ny. Jinak se v≈ædy p≈ôedpokl√°d√°, ≈æe
  se bude pracovat s ji≈æ konvertovan√Ωmi DjVu soubory.

  Je-li [2msuffix[22m uveden, budou konvertov√°ny soubory vyhovuj√≠c√≠ vzorku.
  Pokud nƒõkter√© z nich ji≈æ konvertov√°ny byly, tak se se f√°ze konverze
  p≈ôeskoƒç√≠. Pracuje se pak s ji≈æ existuj√≠c√≠m DjVu souborem.

  Konvertov√°ny jsou pouze soubory, kter√© chyb√≠. Kvalitu konverze lze
  ovlivnit  dal≈°√≠mi parametry. Maj√≠-li b√Ωt soubory p≈ôekonvertov√°ny znovu,
  lze si to vynutit parametrem -f (--force) a st√°vaj√≠c√≠ soubory  p≈ôepsat.

  Akceptovan√© sufixy: 
     djvu (default), jpg, gif, png, bmp, pnm, pbm, pgm.
  V√≠cevrstv√© soubory:
     xcf, tiff, pdf 
"""
			;;
		*) echo """
[1mPou≈æit√≠[0m ${0##/}:

 [1m${0##/}[0m [volby] {vzorek|dir/|name} docin.djvu

Parametry:
    docin.djvu - vstupn√≠ djvu dokument se kter√Ωm se m√° pracovat
    dir/       - jm√©no adres√°≈ôe se li≈°√≠ od jm√©na ƒçi vzorku lom√≠tkem 
    vzorek     - ≈ôetƒõzec, kter√Ωm se maj√≠ vyselektovat soubory s nimi≈æ se
                 m√° pracovat - je to ƒç√°st jm√©na souboru, kter√° p≈ôedch√°z√≠
                 jeho po≈ôadov√©mu ƒç√≠slu

Volby: 
  -h            N√°povƒõda
  -f|--force
  -i|--indirect V√Ωsledekm zpracov√°n√≠ bude voln√Ω svazek
  -b|--bundle   V√Ωsledekm zpracov√°n√≠ bude kompaktn√≠ svazek ( default)
  -d|--dsed P≈ôi pr√°ci s textovou vrstvou se bude pracovat s form√°tem
              dsed (lisp)
  -x|--xml  P≈ôi pr√°ci s textovou vrstvou se bude pracovat s form√°tem
              xml
  --pdf   Pro konverzi PDF souboru se pou≈æije n√°stroj pdf2djvu, kter√Ω je
  schopen p≈ôev√©st i textovou vrstvu - pokud v PDF souboru existuje.

Parametrick√© volby:
   -n|--name    parametr zajist√≠, ≈æe se soubory p≈ôejmenuj√≠
   -r|--rename  ≈ôetƒõzec, kter√Ω se m√° pou≈æ√≠t k pojmenov√°n√≠ soubor≈Ø m√≠sto 
                st√°vaj√≠c√≠ch n√°zv≈Ø soubor≈Ø p≈ôi sestaven√≠ svazku 
                soubor_0000 - soubor_0001.djvu .. soubor_0123.djvu
                soubor_0 -    soubor_1.djvu ,, soubor_123.djvu

Rozbalen√≠ do voln√©ho svazku:

$0 [volby] dirname/ [index.djvu] [name] docin.djvu

    dirname/ - jm√©no adres√°≈ôe, kter√Ω nemus√≠ existovat
    docin.djvu - vstupn√≠ DjVu soubor (mus√≠ existovat)

Sbalen√≠ do svazku:

$0 [volby] index.djvu bundle.djvu

    bundle.djvu - jm√©no c√≠lov√©ho svazku (nemus√≠ existovat)

Vytvo≈ôen√≠ nov√©ho svazku:

$0 [volby] vzor docout.djvu

    vzor - nesm√≠ odpov√≠dat jm√©nu existuj√≠c√≠ho adres√°≈ôe nebo souboru
    docout.djvu - jm√©no c√≠lov√©ho djvu svazku (typ urƒçuje volba)
    -b - 
    -i - voln√Ω svazek
    -n - parametr zajist√≠, ≈æe se soubory p≈ôejmenuj√≠

Svazek sestavuje z djvu soubor≈Ø s n√°zvem vyhovuj√≠c√≠m vzorku. P≈ô√≠klad:

    $0 -i test novysoubor.djvu

Vyhled√° soubory test-1.djvu, test-2.djvu, ... a sestav√≠ do voln√©ho svazku
s indexov√Ωm souborem novysoubor.djvu.

Pokud je uveden parametr -n, budou d√≠lƒç√≠ dokumenty p≈ôejmenov√°ny tak, aby
odpov√≠daly n√°zvu svazku: novysoubor-001.djvu, novysoubor-002.djvu, ...

"""
		;;
	esac
}

function todjvu {
	if [ "${TEST}" == "yes" ] ; then
		for i in ${ALG[@]} ; do 
			didjvu encode -o "${2/.djvu/.$i.djvu}" -d "${DPI-300}" ${LEVEL} -m "$i" "$1"
			getocr ${2/.djvu/.$i.djvu}
		done
	else
		if [ -f "$1" ] ; then
			didjvu encode -o "$2" -d "${DPI-300}" ${LEVEL} -m "${ALG}" "$1"
			getocr ${2}
		fi
	fi
}

function todotest {
	for i in ${ALG[@]} ; do 
		didjvu encode -o "${1%.*}-$i.djvu" -d 300 -m "$i" "$1"
	done
}

function todoview {
	for i in ${ALG[@]} ; do 
		(djview ${1%.*}-$i.djvu &)
	done
}

function todjvuclassic {
    RANDOMKEY=$[ 8000 + $[ RANDOM % 1000 ]]
    TEMP_DIR="${TEMPDIR}/$WINDOWID$BASHPID$RANDOMKEY"
    mkdir $TEMP_DIR
    TEMP_IMG="$TEMP_DIR/temp.ppm"
    TEMP_MASK="$TEMP_DIR/mask.pbm"
    DJVU_MASK="$TEMP_DIR/mask.djvu"

    case ${1##*.} in
        tiff|tif) KONVERT="${TIFFTOPNM}";;
        png) KONVERT="${PNGTOPNM}";;
        jpg) KONVERT="${JPEGTOPNM}" ;;
    esac

    $KONVERT $1 | tee $TEMP_IMG | ${PPMTOPGM} | ${PGMTOPBM} -threshold -value 0.${3-5} | ${PNMTOPLAINPNM} > $TEMP_MASK;
    ${CJB2} -lossy -clean $TEMP_MASK $DJVU_MASK;
    ${DJVUMAKE} ${1/.png/.djvu} Sjbz=$DJVU_MASK PPM=$TEMP_IMG;
    getocr ${1/.png/.djvu}
    rm -rf $TEMP_DIR
}

# Zpracov√°n√≠ parametr≈Ø p≈ôedan√Ωch p≈ôi startu skriptu
function main {
while [ $# -gt 0 ]
do case "$1" in
	---indirect) if [ "$2" == "-h" ] ; then
				help indirect && exit 0
			else
				INDIRECT=yes
			fi
		;;
	-d|--dsed) DSED=yes
		;;
	--no-thumbnail) THUMBNAIL=no
		;;
	--dpi) if [ "$2" -ge "72" ] || [ "$2" -le "6000" ] ; then
				DPI="$2"
				shift
			else
				help dpi && exit 0
			fi
		;;
	-x|--xml) XML=yes
		;;
	-f|--force) FORCE=yes
		;;
    -h) help && exit 0
		;;
	--clean) LEVEL="--loss-level=1"
		;;
	--lossy) LEVEL="--loss-level=100"
		;;
	--lossless) LEVEL="--loss-level=0"
		;;
	--loss-level) if [ "$2" -ge "0" ] || [ "$2" -lt "200" ] ; then
				LEVEL="--loss-level=1"
				shift
			else
				help level && exit 0
			fi
		;;
	-m|--manual) [ -f $0.manual ] && less -R $0.manual
		exit 0
		;;
	--pdf) PDF2DJVU=$(which pdf2djvu)
[ ! ${PDF2DJVU} ] && echo 'Nen√≠ nainstalov√°n bal√≠k pdf2djvu, kter√Ω je nezbytn√Ω pokud chcete prov√©st p≈ô√≠mou konverzi PDF souboru do DjVu form√°tu' && PDF2DJVU=false
	;;
	-r|--rename) case "$2" in
		*0) RENAME="$2" && shift
				;;
		*) help rename && exit 0
			;;
		esac
		;;
	-s|--sufix) case "$2" in
			jpg|jpeg|png|tiff|pnm|pbm|gif|djvu) SUFFIX=".$2" && shift
				;;
				*) help suffix && exit 0
				;;
			esac
		;;
	--test) TEST="yes"
		;;
	--test-conversion) ALG="abutaleb bernsen brink djvu niblack otsu sauvola shading-subtraction"
		TEST="yes"
		;;
	--view) # Zobrazen√≠ souboru
			echo "Je≈°tƒõ neimplementov√°no"
			exit 100
			if [ -f "$2" ] ; then
				# P≈ôed√°v√° se soubor... obr√°zek ƒçi nƒõco jin√©ho?
				todoview "${2}"
			elif [ -d "$2" ] ; then
				# P≈ôed√°v√° se adres√°≈ô
				echo "Je≈°tƒõ nen√≠ implementov√°no"
			else
				$0 -h
				exit 0
			fi
		;;
	-a|--algorithm) [ "$2" == "-h" ] && for i in ${ALG[@]} ; do 
					echo "$i"
				done && exit 0 || ALG="$2" ; shift
		;;
	-o|--ocr) if [ "$2" == "-h" ] ; then
				help ocr && exit 0
			elif [ "${#2}" == "3" ] ; then
				OCR="$2"
				shift
			else
				OCR="ces"
			fi
		;;
	*) if [ -f "${1}" ] ; then
			case "${1##*.}" in
				djvu|DJVU) # echo "m√°-li prvn√≠ soubor p≈ô√≠ponu djvu.. ${2//[0-9]/}"
					if [ "${2//[0-9,-]/}" == "" ] ; then
						echo "Extrakce str√°nek vybran√Ωch ƒç√≠seln√Ωm rozsahem z DjVu svazku"
						exit 0
					elif [ -f "${2}" ] ; then
						case "${2##*.}" in
							dsed|xml) echo "n√°sleduje textov√Ω soubor $2, nejsp√≠≈° ho chci vlo≈æit do $1"
							;;
							djvu) echo "n√°sleduje djvu soubor $2"
							;;
							*) echo "Nedƒõl√°m nic - nejsp√≠≈° chyba.." && exit 7
							;;
						esac
					else
						# Keywords
						case "${2}" in
							export) [ "${3}" == "-h" ] && help keywords-export && exit 0
								exportpage ${1} ${3} ${4}
								exit 0
							;;
							import) [ "${3}" == "-h" ] && help keywords-import && exit 0
								echo "vlo≈æen√≠ xml"
								help keywords-import
								echo "ToDo"
								exit 0
							;;
							set) [ "${3}" == "-h" ] && help keywords-set && exit 0
								echo "vlo≈æen√≠ metainformace"
								echo "ToDo"
								exit 0
							;;
							print) [ "${3}" == "-h" ] && help keywords-print && exit 0
								echo "V√Ωpis metainformace"
								echo "ToDo"
								exit 0
							;;
							forward) [ "${3}" == "-h" ] && help keywords-forward && exit 0
								[ -f ${3} ] && echo "pro vlo≈æen√≠ nov√© str√°nky do souboru je urƒçena akce insert" >> /dev/stderr && exit 1
								forwardpage ${1} ${3} ${4}
								exit 0
							;;
							back) [ "${3}" == "-h" ] && help keywords-back && exit 0
								[ -f ${3} ] && echo "pro vlo≈æen√≠ nov√© str√°nky do souboru je urƒçena akce insert" >> /dev/stderr && exit 1
								backpage ${1} ${3} ${4}
								exit 0
							;;
							rotate)  [ "${3}" == "-h" ] && help keywords-rotate && exit 0
								rotatepage ${1} ${3} ${4}
								exit 0
							;;
							delete)  [ "${3}" == "-h" ] && help keywords-delete && exit 0
								deletepage ${1} ${3}
								exit 0
							;;
							insert) [ "${3}" == "-h" ] && help keywords-insert && exit 0
								if [ -f ${3} ] ; then
									[ "${#ALG[@]}" == "1" ] || exit 32
									TEMPFILE="$TEMPDIR/${3%.*}.djvu"
									todjvu ${3} ${TEMPFILE}
									if [ $? -gt "0" ] ; then
										echo "Soubor ${3} se nepoda≈ôilo zkonvertovat do souboru ${TEMPFILE}"
										exit 33
									else
										insertpage ${1} ${TEMPFILE} ${4}
									fi
								else
									echo "Vlo≈æit lze pouze existuj√≠c√≠ djvu soubor"
									exit 1
								fi
								exit 0
							;;
							*) help keywords && exit 0
						esac
					fi
				echo '''Pokud n√°sleduje djvu soubor'''
				echo '''Pokud n√°sleduje adres√°≈ô'''
				echo '''to je existuj√≠c√≠ soubor typu bundle a:
				- nen√°sleduje ≈æ√°dn√Ω dal≈°√≠ existuj√≠c√≠ soubor typu djvu, nebo adres√°≈ô
				  a z√°rove≈à existuje $DIRECTORY, pak to znamen√° ≈æe se m√° rozbalit
				- pokud n√°sleduje dal≈°√≠ soubor, pak to znamen√° ≈æe se m√° nƒõjak√Ωm zp≈Øsobem s t√≠mto dal≈°√≠m souborem nalo≈æit. Je-li to:
					- djvu soubor, m√° se p≈ôipojit
					- xml soubor, m√° se vlo≈æit
					- soubor typu dsed m√° se zpracovat
					- jin√Ω soubor - obr√°zek, kter√Ω se m√° p≈ôev√©st a vlo≈æit
				'''
				
				;;
				xcf|XCF) echo "m√°-li prvn√≠ soubor p≈ô√≠ponu xcf"
				;;
				xml|XML) echo "m√°-li prvn√≠ soubor p≈ô√≠ponu xml"
				;;
				*) echo "m√°-li p≈ô√≠ponu ${1##*.} soubor $1 nƒõco nƒõco jin√©ho"
				;;
			esac
		elif [ -d "${1}" ] ; then
			# P≈ôed√°v√° se adres√°≈ô
				echo "Je-li toto existuj√≠c√≠ adres√°≈ô, tak to m≈Ø≈æe znamenat, ≈æe se bude d√°le pracovat v nƒõm, nebo s n√≠m - z√°le≈æ√≠ na dal≈°√≠m parametru"
				DIRECTORY="${1:0:$((${#1}-1))}"
		elif [ "${2}" ] ; then
			# Sem se spadne, pokud p≈ôedch√°zej√≠c√≠ polo≈æka vede na neexistuj√≠c√≠ soubor
			if [ "${1:$((${#1}-1)):1}" == "/" ] ; then
				if [ "${2:$((${#2}-5))}" == ".djvu" ] ; then
					echo "Rozbalen√≠ DjVu svazku : Prvn√≠ polo≈æka je jm√©no adres√°≈ôe a druh√° DjVu soubor, kter√Ω se m√° rozbalit"
					djvuunbundle "$1" "$2" 
					exit 0
				else
					if [ -f "{2}" ] ; then
						echo "? : Prvn√≠ polo≈æka je jm√©no adres√°≈ôe a druh√° jm√©no existuj√≠c√≠ho souboru, kter√Ω nen√≠ typu DjVu"
					else
						echo "? : Prvn√≠ polo≈æka je jm√©no adres√°≈ôe a druh√° ≈ôetƒõzec - pravdƒõpodobnƒõ bude n√°sledovat polo≈æka t≈ôet√≠... to mohl b√Ωt vzorek"
					fi
				fi
			elif [ "${2:$((${#2}-5))}" == ".djvu" ] ; then
				#echo "Vytvo≈ôen√≠ DjVu svazku - konverze, OCR, textov√© soubory, n√°hled, integrace a nakonec sestaven√≠"
				# $1 vzorek
				# $2 jm√©no budouc√≠ho DjVu svazku
				# $2 ƒç√≠slo souboru, kter√Ω se m√° zpracovat (nen√≠-li uvedeno, zpracuj√≠ se v≈°echny)
				djvubundle "$1" "$2" "$3"
				exit 0
			else
				# Sem to propadne, kdy≈æ soubor neexistuje.. jm√©no vzorku...
				case "${2:$((${#2}-3))}" in
					tiff) echo "Soubor $1 se bude exportovat do souboru $2"
						;;
					pdf) echo "Soubor $1 se bude exportovat do souboru $2"
						;;
					xcf) echo "za ≈ôetƒõzcem n√°sleduje jm√©no xcf souboru, tak≈æe pokud neexistuje $DIRECTORY, je $1 - jm√©no budouc√≠ho djvu souboru a $2 jm√©no v√≠cevrstv√©ho xcf souboru."
						echo "zavolat funkci pro konverzi xcf2djvu a skonƒçit"
						exit 0
						;;
					mng) echo "Soubor $1 se bude exportovat do souboru $2"
						;;
					*) echo "sem nic ${1} - ${2} - ${2:$((${#2}-3))}"
						exit  200
						;;
				esac
			fi
		else
			$0 -h
			exit 0
		fi
	;;
	esac
	shift
done
}

main $@

exit 0
