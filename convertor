#!/bin/bash
# -*- mode: sh -*-

# convertor - tool for conversion and work DjVu files
#
# Author: Ale≈° Kapica <kapica@fel.cvut.cz>, 2015
#
# Pou≈æit√≠...
# convertor [test] image
#	provede testovac√≠ konverzi pro v≈°echny dostupn√© separaƒçn√≠ algoritmy didjvu
shopt -s extglob

# Changelog
# - o≈°et≈ôena situace, kdy nen√≠ nainstalov√°n ocrodjvu
# - o≈°et≈ôit situaci, kdy soubor neobsahuje ≈æ√°dn√Ω textov√Ω obsah a soubor dsed, ani xml neexistuje
# - mezi kl√≠ƒçov√© operace p≈ôid√°no delete a insert
# - OCR zpracovan√© do samostatn√© funkce
# - v√Ωchoz√≠ algoritmus djvu; testovac√≠ konverze pro v≈°echny algoritmy se
#   provede pouze je-li uveden parametr --test-conversion
# - implementov√°na rotace str√°nky
# - implementov√°ny p≈ôesuny str√°nek (akce fore a back)
# - implementov√°no generov√°n√≠ n√°hled≈Ø do exportu
# - upraveny funkce pro export n√°hled≈Ø a soubor≈Ø textov√© vrstvy
# - implementov√°na akce print pro v√Ωpis metadat

# ToDo
# p≈ôepracovat pou≈æit√≠ djvudump na djvm -l (je rychlej≈°√≠..)
# implementovat kontrolu do funkce todjvu, aby nedoch√°zelo k nekontrolovateln√©mu vkl√°d√°n√≠ ji≈æ existuj√≠c√≠ch str√°nek
# - p≈ôidat kontrolu do akce insert na duplicitn√≠ soubory p≈ôi vkl√°d√°n√≠
#   v√≠cestr√°nkov√Ωch DjVu soubor≈Ø. to ov≈°em bude vy≈æadovat samostatnou
#   funkci...
# - dopsat n√°povƒõdu pro akci keywords-unset 
# - dopsat manu√°l pro akci set, argumenty, xmp, atp.
# - implementovat import
# doplnit n√°povƒõdu k rotaci str√°nky (akce rotate)
# opravit volby --algoritmus a --view
NAME="convertor"
[ -d "${HOME}/.config/${NAME}" ] &&	. ${HOME}/.config/${NAME}/* &>>/dev/null

LOG="${LOG=/dev/stderr}"
XML="${XML=no}"
DSED="${DSED=no}"
INDIRECT="${INDIRECT=no}"
FORCE="${FORCE=no}"
RENAME="no"
EXTENSION=".djvu"
THUMBNAIL="${THUMBNAIL=no}"
INSERTTEXT="${INSERTTEXT=no}"
ALG="${ALG=djvu}"
EXTRACTPAGE="${EXTRACTPAGE=no}"
IMGPAGE="${IMGPAGE=no}"

trap '''CHYBA=$? ;
case $CHYBA in
 20) echo "Nen√≠ nainstalov√°n bal√≠k djvu-tools"
 ;;
 21) echo "ERROR: mimetype - tool for detection type of image"
 ;;
 22) echo "ERROR: readlink - tool for detection absolute path of directory"
 ;;
 23) echo "Nen√≠ nainstalov√°n bal√≠k netpbm-sf"
 ;;
 24) "ERROR: imagemagick - tool for image convert is not installed"
 ;;
 31) echo "Nen√≠ nainstalov√°n bal√≠k ocrodjvu, na djvu soubory nelze aplikovat OCR. Buƒèto jej doinstalujte, nebo odstra≈àte z p≈ô√≠kazov√© ≈ô√°dky parametr -o (--ocr)" >> /dev/stderr
 ;;
 32) echo "Pokud m√° p≈ôi operaci zpracovat do DjVu bitmapov√Ω soubor, je t≈ôeba uv√©st na p≈ô√≠kazov√© ≈ô√°dce parametrem -a jak√Ω se m√° pou≈æ√≠t algoritmus. Jak√© parametry lze pou≈æ√≠t se dozv√≠te pokud m√≠sto jm√©na algoritmu nap√≠≈°ete znak ?" >> /dev/stderr
 ;;
 33) NORMDIR=yes
 ;;
esac
[ $NORMDIR ] || rm -rf -- "$TEMPDIR"
exit $CHYBA
''' EXIT

TEMPDIR=$(mktemp -d -p /tmp ${NAME}-XXX) || exit 1

#=== testy z√°vislost√≠ ===
# Dependencies:
#   * feh      ( http://feh.finalrewind.org/ )
#   * exiftool ( http://www.sno.phy.queensu.ca/~phil/exiftool ) in Debian package: libimage-exiftool-perl 
#   * yad      ( http://sourceforge.net/projects/yad-dialog )
REALPATH=$(which realpath)
[ ! ${REALPATH} ] && exit 1
REALPATH="$REALPATH -e "

DIDJVU=$(which didjvu)
[ ! ${DIDJVU} ] && echo 'Nen√≠ nainstalov√°n bal√≠k didjvu, nebude mo≈æn√© aplikovat pokroƒçil√© algoritmy pro separaci pop≈ôed√≠ p≈ôi konverzi do DjVu' >> /dev/stderr && DIDJVU=false
OCRODJVU=$(which ocrodjvu)
[ ! ${OCRODJVU} ] && OCRODJVU=31
DJVIEW=$(which djview)
[ ! ${DJVIEW} ] && echo 'Nen√≠ nainstalov√°n bal√≠k djview, nebude fungovat testovac√≠ zobrazen√≠ djvu.soubor≈Ø' >> /dev/stderr && DJVIEW=false
DDJVU=$(which ddjvu)
[ ! ${DDJVU} ] && exit 20
DJVUTXT=$(which djvutxt)
[ ! ${DJVUTXT} ] && exit 20
DJVUSED=$(which djvused)
[ ! ${DJVUSED} ] && exit 20
DJVUTOXML=$(which djvutoxml)
[ ! ${DJVUTOXML} ] && exit 20
DJVUXMLPARSER=$(which djvuxmlparser)
[ ! ${DJVUXMLPARSER} ] && exit 20
DJVUDUMP=$(which djvudump)
[ ! ${DJVUDUMP} ] && exit 20
DJVMCVT=$(which djvmcvt)
[ ! ${DJVMCVT} ] && exit 20
DJVM=$(which djvm)
[ ! ${DJVM} ] && exit 20
CJB2=$(which cjb2)
[ ! ${CJB2} ] && exit 20
DJVUMAKE=$(which djvumake)
[ ! ${DJVUMAKE} ] && exit 20
#YAD=$(which yad)
#[ ! ${YAD} ] && echo 'Nen√≠ nainstalov√°n bal√≠k yad' && exit 1
MIME=$(which mimetype)
[ ! -x "${MIME}" ] && exit 21
STAT=$(which readlink)
[ ! -x "${STAT}" ] && exit 22
EXIFTOOL=$(which exiftool)
[ ! -x "${EXIFTOOL}" ] && exit 23


NETPBM=0
PNMSCALE=$(which pnmscale)
[ ! -x "${PNMSCALE}" ] && NETPBM=1
if (( $NETPBM == 0 )); then
    VERSION=($(${PNMSCALE} -version 2>&1 | head -1))
    case ${VERSION[$((${#VERSION[@]} - 1))]} in
	10.0*|9*) echo "WARNING: Version Netpbm pnmacele don't support filters. I must use imagemagick convert" >> /dev/stderr
	    NETPBM=1
	    ;;
	*)  NETPBM=0
	    BMPTOPNM=$(which bmptopnm)
	    [ ! -x "${BMPTOPNM}" ] && exit 23
	    JPEGTOPNM=$(which jpegtopnm)
	    [ ! -x "${JPEGTOPNM}" ] && exit 23
	    GIFTOPNM=$(which giftopnm)
	    [ ! -x "${GIFTOPNM}" ] && exit 23
	    PNGTOPNM=$(which pngtopnm)
	    [ ! -x "${PNGTOPNM}" ] && exit 23
	    PNMTOJPEG=$(which pnmtojpeg)
	    [ ! -x "${PNMTOJPEG}" ] && exit 23
	    TIFFTOPNM=$(which tifftopnm)
	    [ ! -x "${TIFFTOPNM}" ] && exit 23
	    PNMTOPNG=$(which pnmtopng)
	    [ ! -x "${PNMTOPNG}" ] && exit 23
	    PNMTOPLAINPNM=$(which pnmtoplainpnm)
	    [ ! -x "${PNMTOPLAINPNM}" ] && exit 23
	    PPMTOPGM=$(which ppmtopgm)
	    [ ! -x "${PPMTOPGM}" ] && exit 23
	    PGMTOPBM=$(which pgmtopbm)
	    [ ! -x "${PGMTOPBM}" ] && exit 23
	    ;;
    esac
fi
if (( $NETPBM == 1 )) ; then
    CONVERT=$(which convert)
    [ ! -x "${CONVERT}" ] && echo exit 24
fi
#=== konec testu z√°vislost√≠ ===
function log {
	# $1 - z√°va≈ænost hl√°≈°ky
	# $2 - textov√Ω ≈ôetƒõzec..
	# $DEBUG √∫rove≈à logov√°n√≠
	# $LOG - v√Ωstup (default - /dev/null
	case "${1}" in
		1) # Hl√°≈°ky up≈ôes≈àuj√≠c√≠ m√≠sto ve skriptu
		echo "${@:2}" >> ${LOG}
		;;
		0) # Bƒõ≈æn√© hl√°≈°ky
		echo "${1}" >> ${LOG}
		;;
		*)
		;;
	esac
}
function rozvazat {
	# $1 - soubor
	# $2 - adres√°≈ô
	# $3 - indexov√Ω soubor
	echo "rozvazat - $1 - $2 - $3" >> /dev/stderr
	if [ -d "${2}" ] ; then
		if [ -z "${3}" ] ; then
			${DJVMCVT} -i ${1} ${2} index.djvu
		else
			${DJVMCVT} -i ${1} ${2} ${3}
		fi
	fi
}

function testfile {
	# $1 - soubor
	local LOCALFILE="$*"
	if [ -f "$*" ] ; then
		local TYPE=$(${MIME} -dbM "${LOCALFILE}" | awk '{print $1}')
	else
		echo "testfile: P≈ôedan√Ω soubor ${LOCALFILE} nemohu naj√≠t" >> /dev/stderr
		exit 1
	fi
	echo ${TYPE,,}
}

function escape_path {
	echo "escape_path $*" >> /dev/stderr
	echo "$*" | sed \
  -e 's/\ /\\\ /g'
}

potvrdit () {
    read -r -p "${1:-Opravdu chcete akci prov√©st? [y/N]} " response
    case $response in
        [yY][eE][sS]|[yY]) 
            true
            ;;
        [aA][nN][oO]|[aA]) 
            true
            ;;
        *)
            false
            ;;
    esac
}

function setmeta {
	# $1 - svazek
	# $2 - identifik√°tor, kl√≠ƒçov√© slovo nebo soubor
	# $3 - key
	# $4 - obsah kl√≠ƒçe
	if [ -f ${2} ] ; then
		echo "Importuji atributy ze souboru ${2}" >> /dev/stderr
		${DJVUSED} ${1} -e "set-meta ${2}; save"
	else
		identifypage ${1} ${2}
		NAMEPAGE=$(identifyname ${1} $?)
		if [ "${NAMEPAGE}" == "" ] ; then
			echo "Neplatn√Ω identifik√°tor str√°nky ${2}" >> /dev/stderr
			exit 12
		fi
		if [ "${3}" == "" ] ; then
			if [ -f ${NAMEPAGE/.djvu/.meta} ] ; then
				echo "Nastavuji kl√≠ƒç $3 do str√°nky $PAGE v souboru $1 s obsahem ${@:4}" >> /dev/stderr
				${DJVUSED} ${1} -e "select ${NAMEPAGE}; set-meta ${NAMEPAGE/.djvu/.meta}; save"
			fi
		else
			${DJVUSED} ${1} -e "select ${NAMEPAGE}; print-meta" > $TEMPDIR/${NAMEPAGE/.djvu/.meta}
			echo "${@:3}" >> $TEMPDIR/${NAMEPAGE/.djvu/.meta}
			${DJVUSED} ${1} -e "select ${NAMEPAGE}; set-meta $TEMPDIR/${NAMEPAGE/.djvu/.meta}; save"
		fi
	fi
}

function printmeta {
	# $1 - svazek
	# $2 - identifik√°tor, kl√≠ƒçov√© slovo 'all' nebo atribut
	# $3 - atribut, nebo kl√≠ƒçov√© slovo 'all' (default)
	# nen√≠-li urƒçena str√°nka ani key vyp√≠≈°e pro cel√Ω dokument
	if [ "${2}" = "" ] ; then
		echo "Glob√°ln√≠ metadata souboru ${1##*/} :" >> /dev/stderr
		METAKEYS=$(${DJVUSED} ${1} -e print-meta)
		IFS_BAK=$IFS
		IFS=$'\n'
		for i in $METAKEYS ; do
			echo -e $(echo $i | sed 's/\\/\\0/g')
		done
		IFS=$IFS_BAK
	else
		identifypage ${1} ${2}
		PAGE=$?
		NAMEPAGE=$(identifyname ${1} ${PAGE})
		if [ "${NAMEPAGE}" == "" ] ; then
			if [ "${2}" == "all" ] ; then
				echo "Glob√°ln√≠ metadata souboru ${1##*/} :" >> /dev/stderr
			else
				if [ "${2/[0-9]/}" == "" ] ; then
					lastpage ${1}
					LASTPAGE=$?
					if [ ${2} -gt ${LASTPAGE} ] ; then
						echo "Po≈æadovan√° str√°nka je mimo rozsah souboru ${1##*/}, kter√Ω m√° ${LASTPAGE} a po≈æadovan√° str√°nka se v nƒõm nevyskytuje" >> /dev/stderr
					else
						echo "Glob√°ln√≠ metadata souboru ${1##*/} - atribut ${2}:" >> /dev/stderr
					fi
				else
					echo "Str√°nka ${2} se v souboru ${1##*/} nevyskytuje" >> /dev/stderr
					exit 1
				fi
			fi
			METAKEYS=$(${DJVUSED} ${1} -e "print-meta")
			IFS_BAK=$IFS
			IFS=$'\n'
			for i in $METAKEYS ; do
				if [ "${2}" == "all" ] ; then
					echo -e $(echo $i | sed 's/\\/\\0/g')
				else
					KEY=$(echo $i | grep "^${2}[[:blank:]]" | sed 's/\\/\\0/g')
					if [ "$KEY" == "" ] ; then
						continue
					else
						echo -e $KEY
					fi
				fi
			done
			IFS=$IFS_BAK
		else
			if [ "${3}" == "" ] || [ "${3}" == "all" ] ; then
				echo "Metadata str√°nky ${NAMEPAGE} ( $PAGE ) ze souboru ${1##*/} :" >> /dev/stderr
			else
				echo "Metadata str√°nky ${NAMEPAGE} ( $PAGE ) ze souboru ${1##*/} - atribut ${3}:" >> /dev/stderr
			fi
			METAKEYS=$(${DJVUSED} ${1} -e "select ${NAMEPAGE}; print-meta")
			IFS_BAK=$IFS
			IFS=$'\n'
			for i in $METAKEYS ; do
				if [ "${3}" == "" ] || [ "${3}" == "all" ] ; then
					echo -e $(echo $i | sed 's/\\/\\0/g')
				else
					KEY=$(echo $i | grep "^${3}[[:blank:]]" | sed 's/\\/\\0/g')
					if [ "$KEY" == "" ] ; then
						continue
					else
						echo -e $KEY
					fi
				fi
			done
			IFS=$IFS_BAK
		fi
	fi
}

function unsetmeta {
	# $1 - svazek
	# $2 - identifik√°tor, kl√≠ƒçov√© slovo nebo soubor
	# $3 - key
	identifypage ${1} ${2}
	NAMEPAGE=$(identifyname ${1} $?)
	if [ "${NAMEPAGE}" == "" ] ; then
		echo "Odstra≈àuji glob√°ln√≠ atribut.."
		${DJVUSED} ${1} -e "print-meta" > ${TEMPDIR}/${1/.djvu/.temp}
		grep -v "^$2[[:blank:]]" ${TEMPDIR}/${1/.djvu/.temp} >> $TEMPDIR/${1/.djvu/.meta}
		potvrdit && ${DJVUSED} ${1} -e "set-meta $TEMPDIR/${1/.djvu/.meta}; save"
	elif [ "${3}" == "" ] ; then
		echo "Odstra≈àuji v≈°echny meta informace ze str√°nky.."
		potvrdit && ${DJVUSED} ${1} -e "select ${NAMEPAGE}; remove-meta; save"
	elif [ "${2}" == "global" ] ; then
		echo "Odstra≈àuji v≈°echny glob√°ln√≠ meta informace.."
		potvrdit && ${DJVUSED} ${1} -e "remove-meta; save"
	else
		echo "Odstra≈àuji atribut ${3} z meta informac√≠ str√°nky ${NAMEPAGE}"
		echo "$1 - $2 - $3 - $NAMEPAGE"
		${DJVUSED} ${1} -e "select ${NAMEPAGE}; print-meta" > ${TEMPDIR}/${NAMEPAGE/.djvu/.temp}
		grep -v "^$3[[:blank:]]" ${TEMPDIR}/${NAMEPAGE/.djvu/.temp} >> ${TEMPDIR}/${NAMEPAGE/.djvu/.meta}
		potvrdit && ${DJVUSED} ${1} -e "select ${NAMEPAGE}; set-meta $TEMPDIR/${NAMEPAGE/.djvu/.meta}; save"
	fi
	exit 33
}

function exportpage {
	# $1 - svazek
	# $2 - identifik√°tor
	# $3 - c√≠l (adres√°≈ô)
	if [ ${#3} -eq "0" ] ; then
		TARGETDIR=$(${REALPATH} ./)
	elif [ -f "${3}" ] ; then
		TARGET=$(${REALPATH} ${3})
		TARGETDIR=${TARGET%/*}
	elif [ -d "${3}" ] ; then
		TARGETDIR=$(${REALPATH} ${3})
	else
		mkdir -p $3
		if [ $? == "0" ] ; then
			TARGETDIR=$(${REALPATH} ${3})
		else
			echo "C√≠lov√Ω adres√°≈ô $3 nelze vytvo≈ôit"
			exit 1
		fi
	fi
	echo "-$2-" >> /dev/stderr
	case "$2" in
		all) lastpage ${1}
			PAGES=$?
			NUMPAGE=1
			echo $PAGES >> /dev/stderr
			while [ ${PAGES} -gt "0" ] ; do
				identifypage ${1} ${NUMPAGE}
				PAGE=$?
				NAMEPAGE=$(identifyname ${1} $PAGE)
				echo "Zpracov√°v√°m str√°nku ${NAMEPAGE}" >> /dev/stderr
				NUMPAGE=$((NUMPAGE + 1))
				PAGES=$((PAGES - 1))
			done
			if [ ${XML} == "yes" ] ; then
				exportxml ${1} ${TARGETDIR}
			fi
			if [ ${DSED} == "yes" ] ; then
				exportdsed ${1} ${TARGETDIR}
			fi
		;;
		*) identifypage ${1} ${2}
			NAMEPAGE=$(identifyname ${1} $?)
			echo "$NAMEPAGE" >> /dev/stderr
			if [ "${NAMEPAGE}" == "" ] ; then
				echo "Neplatn√Ω identifik√°tor str√°nky $2. Pokud maj√≠ b√Ωt ze souboru vyexportov√°ny v≈°echny str√°nky, je t≈ôeba uv√©st kl√≠ƒçov√© slovo - all" >> /dev/stderr
				exit 13
			else
#				echo "export str√°nky $EXTRACTPAGE - $NAMEPAGE ${#NAMEPAGE} - DSED $DSED - XML $XML - THUMBNAIL $THUMBNAIL - FORCE $FORCE" >> /dev/stderr
				if [ ${IMGPAGE} != "no" ] ; then
					exportimg ${1} ${NAMEPAGE} ${TARGETDIR}
				fi
				if [ ${EXTRACTPAGE} == "yes" ] ; then
					${DJVMCVT} -i ${1} ${TEMPDIR} index.djvu
					if [ -f "${TARGETDIR}/${NAMEPAGE}" ] ; then
						echo "Str√°nka, kterou se chyst√°te exportovat ji≈æ v c√≠lov√© pozici existuje. Chcete ji p≈ôepsat?"
						potvrdit && mv "${TEMPDIR}/${NAMEPAGE}" "${TARGETDIR}/"
						exit 33
					else
						mv "${TEMPDIR}/${NAMEPAGE}" "${TARGETDIR}/"
					fi
				fi
				if [ ${XML} == "yes" ] ; then
					exportxml ${1} ${2} ${TARGETDIR}
				fi
				if [ ${DSED} == "yes" ] ; then
					exportdsed ${1} ${2} ${TARGETDIR}
				fi
			fi
		;;
	esac
	exit 0
}


function exportdsed {
	# $1 - svazek
	# $2 - identifik√°tor nebo adres√°≈ô
	# $3 - adres√°≈ô
	case "${#@}" in
		3) identifypage ${1} ${2}
			PAGE=$?
			NAMEPAGE=$(identifyname ${1} $PAGE)
			if [ -f "${3}/${NAMEPAGE/.djvu/.dsed}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DJVUSED} ${1} -e "select $PAGE; output-all" > ${3}/${NAMEPAGE/.djvu/.dsed}
			else
				${DJVUSED} ${1} -e "select $PAGE; output-all" > ${3}/${NAMEPAGE/.djvu/.dsed}
			fi
		;;
		2) if [ -d ${2} ] ; then
			# echo "P≈ôedan√Ω je adres√°≈ô, bude do nƒõj exportov√°n cel√Ω obsah"
			if [ -f "${2}/${1/.djvu/.dsed}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DJVUSED} ${1} -e output-all > ${2}/${1/.djvu/.dsed}
			else
				${DJVUSED} ${1} -e output-all > ${2}/${1/.djvu/.dsed}
			fi
		else
			identifypage ${1} ${2}
			PAGE=$?
			NAMEPAGE=$(identifyname ${1} $PAGE)
			if [ -f "./${NAMEPAGE/.djvu/.dsed}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DJVUSED} ${1} -e "select $PAGE; output-all" > ./${NAMEPAGE/.djvu/.dsed}
			else
				${DJVUSED} ${1} -e "select $PAGE; output-all" > ./${NAMEPAGE/.djvu/.dsed}
			fi
		fi
		;;
		1) if [ -f "./${1/.djvu/.dsed}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DJVUSED} ${1} -e output-all > ./${1/.djvu/.dsed}
			else
				${DJVUSED} ${1} -e output-all > ./${1/.djvu/.dsed}
			fi
		;;
		*) echo "Z nƒõjak√©ho d≈Øvodu nelze prov√©st export dsed souboru" >> /dev/stderr && exit 1
		;;
	esac
}

function exportxml {
	# $1 - svazek
	# $2 - identifik√°tor nebo adres√°≈ô
	# $3 - adres√°≈ô
	case "${#@}" in
		3) identifypage ${1} ${2}
			PAGE=$?
			NAMEPAGE=$(identifyname ${1} $PAGE)
			if [ -f "${3}/${NAMEPAGE/.djvu/.xml}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DJVUTOXML} --page ${PAGE} ${1} ${3}/${NAMEPAGE/.djvu/.xml}
			else
				${DJVUTOXML} --page ${PAGE} ${1} ${3}/${NAMEPAGE/.djvu/.xml}
				exportimg ${1} ${PAGE} ${3}
			fi
		;;
		2) if [ -d ${2} ] ; then
				if [ -f "${2}/${1/.djvu/.xml}" ] ; then
					[ "${FORCE}" == "yes" ] && ${DJVUTOXML} ${1} ${2}/${1/.djvu/.xml}
				else
					${DJVUTOXML} ${1} ${2}/${1/.djvu/.xml}
				fi
				exportimg ${1} ${2}
			else
			identifypage ${1} ${2}
			PAGE=$?
			NAMEPAGE=$(identifyname ${1} $PAGE)
				if [ -f "./${NAMEPAGE/.djvu/.xml}" ] ; then
					[ "${FORCE}" == "yes" ] && ${DJVUTOXML} --page ${PAGE} ${1} ./${NAMEPAGE/.djvu/.xml}
				else
					${DJVUTOXML} --page ${PAGE} ${1} ./${NAMEPAGE/.djvu/.xml}
				fi
				exportimg ${1} ${PAGE} ./
			fi
		;;
		1) if [ -f "./${1/.djvu/.xml}" ] ; then
				[ "${FORCE}" == "yes" ] && ${DJVUTOXML} ${1} ./${1/.djvu/.xml}
			else
				${DJVUTOXML} ${1} ./${1/.djvu/.xml}
			fi
			exportimg ${1} ./
		;;
		*) echo "Z nƒõjak√©ho d≈Øvodu nelze prov√©st export xml souboru" >> /dev/stderr && exit 1
		;;
	esac
}

function exportimg {
	# Webeditor n√°hled akceptuje pouze pokud vyhovuje numerick√©mu tvaru - tedy ne tvar 001!!!
	# N√°hled se znovu exportuje pouze za p≈ôedpokladu, ≈æe je souƒçasnƒõ uvedena volba --force
	# $1 - svazek
	# $2 - identifik√°tor str√°nky nebo adres√°≈ô
	# $3 - adres√°≈ô
	case "${#@}" in
		3) identifypage ${1} ${2}
			PAGE=$?
			NAMEPAGE=$(identifyname ${1} $PAGE)
			case "${IMGPAGE}" in
				yes)  echo "Exportuji ${NAMEPAGE/.djvu/.png} do ${3}" >> /dev/stderr
				if [ -f "${3}/${NAMEPAGE/.djvu/.png}" ] ; then
						if [ "${FORCE}" == "yes" ] ; then
							${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ${3}/${NAMEPAGE/.djvu/.png}
						else
							echo "Soubor s takov√Ωm n√°zvem v c√≠lov√©m adres√°≈ôi ji≈æ existuje."
							potvrdit && ${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ${3}/${NAMEPAGE/.djvu/.png}
						fi
					else
						${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ${3}/${NAMEPAGE/.djvu/.png}
					fi
				;;
				no) echo "Export obrazov√© vrstvy nen√≠ povolen" >> /dev/stderr
				;;
				*) echo "Exportuji ${NAMEPAGE/.djvu/.${IMGPAGE}.pnm} do ${3}" >> /dev/stderr
					if [ -f "${3}/${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}" ] ; then
						if [ "${FORCE}" == "yes" ] ; then
							${DDJVU} --format=pnm --page=${PAGE} ${1} > ${3}/${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}
						else
							echo "Soubor s takov√Ωm n√°zvem v c√≠lov√©m adres√°≈ôi ji≈æ existuje."
							potvrdit && ${DDJVU} --format=pnm --page=${PAGE} ${1} > ${3}/${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}
						fi
					else
						${DDJVU} --format=pnm --page=${PAGE} ${1} > ${3}/${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}
					fi
				;;
			esac
		;;
		2) if [ -d ${2} ] ; then
			lastpage ${1}
			PAGES=$?
			NUMPAGE=1
			while [ ${PAGES} -gt "0" ] ; do
				identifypage ${1} ${NUMPAGE}
				PAGE=$?
				NAMEPAGE=$(identifyname ${1} $PAGE)
				case "${IMGPAGE}" in
					yes)  echo "Exportuji ${NAMEPAGE/.djvu/.png} do ${2}" >> /dev/stderr
					if [ -f "${2}/${NAMEPAGE/.djvu/.png}" ] ; then
							if [ "${FORCE}" == "yes" ] ; then
								${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ${2}/${NAMEPAGE/.djvu/.png}
							else
								echo "Soubor s takov√Ωm n√°zvem v c√≠lov√©m adres√°≈ôi ji≈æ existuje."
								potvrdit && ${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ${2}/${NAMEPAGE/.djvu/.png}
							fi
						else
							${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ${2}/${NAMEPAGE/.djvu/.png}
						fi
					;;
					no) echo "Export obrazov√© vrstvy nen√≠ povolen" >> /dev/stderr
					;;
					*) echo "Exportuji ${NAMEPAGE/.djvu/.${IMGPAGE}.pnm} do ${2}" >> /dev/stderr
						if [ -f "${2}/${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}" ] ; then
							if [ "${FORCE}" == "yes" ] ; then
								${DDJVU} --format=pnm --page=${PAGE} ${1} > ${2}/${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}
							else
								echo "Soubor s takov√Ωm n√°zvem v c√≠lov√©m adres√°≈ôi ji≈æ existuje."
								potvrdit && ${DDJVU} --format=pnm --page=${PAGE} ${1} > ${2}/${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}
							fi
						else
							${DDJVU} --format=pnm --page=${PAGE} ${1} > ${2}/${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}
						fi
					;;
				esac
				NUMPAGE=$((NUMPAGE + 1))
				PAGES=$((PAGES - 1))
			done
		else
			identifypage ${1} ${2}
			PAGE=$?
			NAMEPAGE=$(identifyname ${1} $PAGE)
			case "${IMGPAGE}" in
				yes)  echo "Exportuji ${NAMEPAGE/.djvu/.png} do ./" >> /dev/stderr
				if [ -f "./${NAMEPAGE/.djvu/.png}" ] ; then
						if [ "${FORCE}" == "yes" ] ; then
							${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ./${NAMEPAGE/.djvu/.png}
						else
							echo "Soubor s takov√Ωm n√°zvem v c√≠lov√©m adres√°≈ôi ji≈æ existuje."
							potvrdit && ${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ./${NAMEPAGE/.djvu/.png}
						fi
					else
						${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ./${NAMEPAGE/.djvu/.png}
					fi
				;;
				no) echo "Export obrazov√© vrstvy nen√≠ povolen" >> /dev/stderr
				;;
				*) echo "Exportuji ${NAMEPAGE/.djvu/.${IMGPAGE}.pnm} do ./" >> /dev/stderr
					if [ -f "./${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}" ] ; then
						if [ "${FORCE}" == "yes" ] ; then
							${DDJVU} --format=pnm --page=${PAGE} ${1} > ./${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}
						else
							echo "Soubor s takov√Ωm n√°zvem v c√≠lov√©m adres√°≈ôi ji≈æ existuje."
							potvrdit && ${DDJVU} --format=pnm --page=${PAGE} ${1} > ./${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}
						fi
					else
						${DDJVU} --format=pnm --page=${PAGE} ${1} > ./${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}
					fi
				;;
			esac
		fi
		;;
		1) lastpage ${1}
			PAGES=$?
			NUMPAGE=1
			while [ ${PAGES} -gt "0" ] ; do
				identifypage ${1} ${NUMPAGE}
				PAGE=$?
				NAMEPAGE=$(identifyname ${1} $PAGE)
				case "${IMGPAGE}" in
					yes)  echo "Exportuji ${NAMEPAGE/.djvu/.png} do ./" >> /dev/stderr
					if [ -f "./${NAMEPAGE/.djvu/.png}" ] ; then
							if [ "${FORCE}" == "yes" ] ; then
								${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ./${NAMEPAGE/.djvu/.png}
							else
								echo "Soubor s takov√Ωm n√°zvem v c√≠lov√©m adres√°≈ôi ji≈æ existuje."
								potvrdit && ${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ./${NAMEPAGE/.djvu/.png}
							fi
						else
							${DDJVU} --format=pnm --page=${PAGE} ${1} | ${PNMTOPNG} > ./${NAMEPAGE/.djvu/.png}
						fi
					;;
					no) echo "Export obrazov√© vrstvy nen√≠ povolen" >> /dev/stderr
					;;
					*) echo "Exportuji ${NAMEPAGE/.djvu/.${IMGPAGE}.pnm} do ./" >> /dev/stderr
						if [ -f "./${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}" ] ; then
							if [ "${FORCE}" == "yes" ] ; then
								${DDJVU} --format=pnm --page=${PAGE} ${1} > ./${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}
							else
								echo "Soubor s takov√Ωm n√°zvem v c√≠lov√©m adres√°≈ôi ji≈æ existuje."
								potvrdit && ${DDJVU} --format=pnm --page=${PAGE} ${1} > ./${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}
							fi
						else
							${DDJVU} --format=pnm --page=${PAGE} ${1} > ./${NAMEPAGE/.djvu/.${IMGPAGE}.pnm}
						fi
					;;
				esac
				NUMPAGE=$((NUMPAGE + 1))
				PAGES=$((PAGES - 1))
			done
		;;
		*) echo "Z nƒõjak√©ho d≈Øvodu nelze prov√©st export n√°hledov√Ωch soubor≈Ø" >> /dev/stderr && exit 1
		;;
	esac
}

function inserttext {
	if [ -f ${1/.djvu/.xml} ] ; then
		${DJVUXMLPARSER} -o ${1} ${1/.djvu/.xml}
	elif [ -f ${1/.djvu/.dsed} ] ; then
		${DJVUSED} ${1} -f ${1/.djvu/.dsed} -s
	fi
}

function insertxmp {
	if [ -f ${1/.djvu/.xmp} ] ; then
		echo "Vkl√°d√°m xmp informace, pokud jsou.."
	fi
}

function konvertor {
	# $1 - vstup
	# $2 - v√Ωstup
	# je-li na vstupu djvu provede pouze operace spojen√© s vyexportov√°n√≠m XML, DSED a n√°hledu v png
	# je-li na vstupu nƒõco jin√©ho ne≈æ png, djvu, dsed, xml, mng, tiff, xcf ƒçi pdf  ovƒõ≈ô√≠ zda-li jde o obr√°zek
	if [ -f "$1" ] ; then
		if [ "${1##*.}" == "djvu" ] ; then
			FROM="$1"
		else
			# konverze a v√Ωsledek bude ve from..
			# SEPARATE - rozdƒõlen√≠ na vrstvy  yes (default) | no
			# DPI - 300 (default)
			# ALG
			todjvu "$1" "$2"
			if [ "$?" !=  "0" ]  ; then
				exit 40
			fi
		fi
		if [ -f "$2" ] && [ "${TEST}" != "yes" ]; then
			if [ ${DSED} == "yes" ] ; then
				if [ -f "${2/.djvu/.dsed}" ] ; then
					if [ ${FORCE} != "no" ] ; then
						rm ${2/.djvu/.dsed}
						exportdsed ${2}
					fi
				else
					exportdsed ${2}
				fi
			fi
			if [ ${XML} == "yes" ] ; then
				if [ -f "${2/.djvu/.xml}" ] ; then
					if [ ${FORCE} != "no" ] ; then
						# exportuji textovou vrstvu v xml, pouze pokud neexistuje, nebo je-li uveden parametr -f (--force)
						# XML ve v√Ωchoz√≠m stavu exportuje jak text tak hyperlinky. Neexportuje v≈°echna metadata!!!
						rm ${2/.djvu/.xml}
						exportxml ${2}
					fi
				else
					exportxml ${2}
				fi
			fi
			if [ ${IMGPAGE} == "yes" ] ; then
				exportimg ${2}
			fi
			if [ ${INSERTTEXT} == "yes" ] && [ ${#OCR} != "3" ] ; then
				inserttext ${2}
			elif [ ! ${OCR} ] ; then
				inserttext ${2}
			fi
		fi
	fi
}

function getocr {
	# $1 - jm√©no djvu souboru 
	if [ "${OCR}" ] ; then
		[ "${OCRODJVU%%+([0-9])}" == "" ] && exit ${OCRODJVU} || ${OCRODJVU} --in-place -l ${OCR} "$1"
	fi
}

function identifybundle {
	# Funkce testuje vstupn√≠ soubor, zda-li je typu DjVu a pak zda-li je 
	# typu svazek (1) nebo samostatn√° str√°nka (0)
	# $1 - soubor
#	log 1 "identifybundle: P≈ôij√≠m√°m vstupn√≠ parametr ${1}"
	if [ "${#1}" -gt "0" ] ; then
		if [ $(testfile "${1}") == "djvu" ] ; then
			local TEST=$(${DJVUDUMP} "${1}" | grep '^\([[:blank:]]*\)DIRM')
#			log 1 "identifyfile: V√Ωstupn√≠ hodnota z djvm - $TEST"
			if [ "${TEST}" == "" ] ; then
#				log 1 "identifybundle: DjVu soubor ${1}"
				return 0
			else
#				log 1 "identifybundle: DjVu svazek ${1}"
				return 1
			fi
		else
			log 1 "identifybundle: Soubor ${FILE} nen√≠ DjVu"
			exit 1
		fi
	else
#		log 1 "identifybundle: Nebyl p≈ôed√°n ≈æ√°dn√Ω parametr"
		exit 1
	fi
}

function identifypage2 {
	# Funkce vracej√≠c√≠ po≈ôadov√© ƒç√≠slo DjVu str√°nky , kter√° je zalo≈æena na djvm
	# $1 soubor
	# $2 testovan√° hodnota
	# NEUM√ç P≈òEVZ√çT KE ZPRACOV√ÅN√ç JM√âNA SOUBOR≈Æ S MEZERAMI!!
	if [ "${2}" == "" ] ; then
		return 0
	elif [ "${2%%+([0-9])}" == "" ] ; then
		local PAGE="\[P$2\]"
	else
		local PAGE="\{${2}\}"
	fi
	local OUTPUT=$(${DJVUDUMP} ${1} | grep FORM:DJVU | grep ${PAGE} | awk -F'[{}]' '{print $3}')
	local ORDER=${OUTPUT//+([\]P\[])/}
	echo ${ORDER}
}

function identifypage {
	# Funkce vracej√≠c√≠ po≈ôadov√© ƒç√≠slo DjVu str√°nky, kter√° je zalo≈æena na djvm
	# $1 soubor
	# $2 testovan√° hodnota
	# NEUM√ç O≈†ET≈òIT MULTIPAGE DOKUMENT
	echo "Vstup ${#@} && ${2}" >> /dev/stderr
	local PAGE="${@:2}"
	echo "Vstup ${PAGE//[[:digit:]]/} && ${PAGE}" >> /dev/stderr
	if [ "${PAGE//[[:digit:]]/}" == "" ] ; then
		echo "ƒå√≠slo ${PAGE}" >> /dev/stderr
		local OUTPUT=($(${DJVM} -l ${1} | grep \#${PAGE}\ ))
		local PAGEORDER=${OUTPUT[@]:2:1}
		echo "Kontroln√≠ v√Ωstup ${OUTPUT[@]}"  >> /dev/stderr
		echo ${PAGEORDER#\#}
	else
		echo "Strana ${PAGE}" >> /dev/stderr
		local OUTPUT=($(${DJVM} -l ${1} | grep \ ${PAGE}$))
		local PAGEORDER=${OUTPUT[@]:2:1}
		echo "Kontroln√≠ v√Ωstup ${OUTPUT[@]}"  >> /dev/stderr
		echo ${PAGEORDER#\#}
	fi
}

function identifyname {
	# Funkce vrac√≠ jm√©no str√°nky na z√°kladƒõ po≈ôadov√©ho ƒç√≠sla str√°nky
	# $1 soubor
	# $2 ƒç√≠slo str√°nky
#	echo "identifyname: Urƒçuji jm√©no ${@} ${#@}" >> /dev/stderr
	if [ "${2%%+([0-9])}" == "" ] ; then
		local PAGE="\[P$2\]"
		#OUTPUT=($(${DJVUDUMP} ${1} | grep FORM:DJVU | grep $PAGE))
#		NAME=(${OUTPUT[@]:2})
#		PAGEORDER=$((${#NAME[@]}-1))
#		VYSTUP=${NAME[@]:0:$PAGEORDER} >> /dev/stderr
#		echo "${VYSTUP//+([\{\}])/}"
#		OUTPUT=$(${DJVUDUMP} ${1} | grep FORM:DJVU | grep $PAGE | tr ' ' '#' | awk -F\{ '{print $2}' | awk -F\} '{print $1}' | tr '#' ' ')
		OUTPUT=$(${DJVUDUMP} ${1} | grep FORM:DJVU | grep $PAGE | awk -F'[{}]' '{print $2}')
		echo ${OUTPUT}
	else
		return 1
	fi
}

function lastpage {
	# Funkce vrac√≠ maxim√°ln√≠ po≈ôadov√© ƒç√≠slo str√°nek
	# $1 jm√©no v√≠cestr√°nkov√©ho djvu souboru
#	log 1 "lastpage: Vstupn√≠ data ${@}"
	[ "$(testfile ${1})" == "djvu" ] || exit 1
	local OUTPUT=$(${DJVUDUMP} ${1} | grep FORM:DJVU | wc -l)
	echo -n "${OUTPUT}"
}

function insertpage {
	# $1 - soubor se kter√Ωm se pracuje
	# $2 - djvu soubor co se m√° vlo≈æit
	# $3 - identifik√°tor str√°nky p≈ôed kterou se m√° vlo≈æit
	log 1 "insertpage: ${@}"
	[ "$(testfile ${1})" == "djvu" ] || exit 1
	case "${#@}" in
		3) # soubor str√°nka a pozice
			log 1 "insertpage: M√°m soubor $1 str√°nku $2 i c√≠lovou pozici.. $3"
			if [ "$(testfile ${2})" == "djvu" ] ; then
				local P=$(identifypage ${1} ${3})
				log 1 "insertpage: P $P"
				if [ -z  "${P}" ] ; then
					echo "insertpage: Identifik√°tor $3 je neplatn√Ω" >> /dev/stderr
					exit 1
				else
					log 1 "insertpage: Vkl√°d√°m ${1} ${2} ${P}"
					${DJVM} -i ${1} ${2} ${P}
				fi
			else
				echo "insertpage: Parametr $2 nen√≠ platn√Ω soubor"
				exit 1
			fi
		;;
		2) # soubor a str√°nka
			if [ "$(testfile ${2})" == "djvu" ] ; then
				log 1 "insertpage: Vkl√°d√°m ${1} ${2}"
				local BMAX=$(lastpage ${2})
				if [ -z "${BMAX}" ] ; then
					log 1 "insertpage: Soubor ${2} nen√≠ svazek"
					local AMAX=$(lastpage ${1})
					if [ -z "${AMAX}" ] ; then
						echo "Soubor $1 zat√≠m nen√≠ DjVU svazek" >> /dev/stderr
						exit 0
					else
						log 1 "insertpage: Soubor $1 je DjVU svazek a m√° ${AMAX} stran"
						while [ "${AMAX}" -gt "0" ] ; do
							log 1 "Zpracov√°v√°m stranu ${AMAX} - ${2##*/}"
							local NAMEPAGE=$(identifypage ${1} ${2##*/})
							if [ -z "${NAMEPAGE}" ] ; then
								log 1 "Str√°nka ${2##*/} v souboru ${1} je≈°tƒõ nen√≠"
							else
								echo "Jedna str√°nka s n√°zvem ${NAMEPAGE} se ji≈æ v souboru ${1} nal√©z√°. P≈ôi vlo≈æen√≠ se ke jm√©nu vkl√°dan√© str√°nky p≈ôid√° po≈ôadov√© ƒç√≠slo. Chcete pokraƒçovat ve vkl√°d√°n√≠?" >> /dev/stderr
								potvrdit && break || exit 0
							fi
							AMAX=$((AMAX -1 ))
						done
						${DJVM} -i ${1} ${2}
					fi
				else
					local AMAX=$(lastpage ${1})
					if [ -z "${AMAX}" ] ; then
						echo "Soubor ${1} nem√° ≈æ√°dn√© str√°nky." >> /dev/stderr
#xxxxxxxx vytvo≈ôen√≠ svazku ze souboru 
# 1, ≈†oupnout str√°nku do doƒçasn√©ho adres√°≈ôe
# 2, A na jej√≠m m√≠stƒõ vytvo≈ôit stejnojmenn√Ω svazek
# 3, Pak ≈°oupnout ty dal≈°√≠ str√°nky
						potvrdit || exit 0
					else
						while [ "${BMAX}" -gt "0" ] ; do
							local NAMEPAGE=$(identifyname ${1} ${BMAX})
							if [ ! -z "${NAMEPAGE}" ] ; then
								if [ ! $(identifyname ${2} ${NAMEPAGE}) ] ; then
									echo "Str√°nka s n√°zvem ${NAMEPAGE}, kter√° je souƒç√°st√≠ souboru ${2} se ji≈æ v souboru ${1} nal√©z√°. Chcete pokraƒçovat ve vkl√°d√°n√≠?" >> /dev/stderr
									potvrdit && break || exit 0
								fi
							fi
							BMAX=$((BMAX -1 ))
						done
							echo "Soubor $2, kter√Ω se chyst√°te vlo≈æit do souboru $1 je v√≠cestr√°nkov√Ω DjVu soubor." >> /dev/stderr
							potvrdit && ${DJVM} -i ${1} ${2}
					fi
				fi
			fi
		;;
	esac
}

function deletepage {
	# $1 - soubor se kter√Ωm se pracuje
	# $2 - ƒç√≠slo, nebo n√°zev strany co se m√° odstranit
	local P=$(identifypage ${1} ${2})
	PAGE=$P
#	echo "deletepage: Str√°nka m√° aktu√°lnƒõ po≈ôadov√© ƒç√≠slo $PAGE" >> /dev/stderr
	if [ ! -z "${PAGE}" ] ; then
#		echo "deletepage: Odstra≈àuji str√°nku $2 - $PAGE ze souboru ${1}"  >> /dev/stderr
		${DJVM} -d ${1} ${PAGE}
#		echo "deletepage: Odstranƒõna str√°nka $2 - $PAGE - $?"  >> /dev/stderr
	else
		echo "Str√°nka $2 v souboru nen√≠. Nezapome≈àte, ≈æe konvertovan√©mu souboru se mƒõn√≠ p≈ô√≠pona!!"
		exit 1
	fi
}

function rotatepage {
	# $1 - soubor se kter√Ωm se pracuje
	# $2 - ƒç√≠slo, nebo n√°zev strany kter√° se m√° rotovat
	# $3 - hodnota rotace
	INFO="""
Uvedenou hodnotu rotace nelze akceptovat. Rotaci lze nastavit buƒè 
absolutnƒõ, a nebo relativnƒõ (pootoƒçit o 90¬∞). AKceptovan√© hodnoty:

      0 - v√Ωchoz√≠ pozice
      1 - natoƒçen√≠ vpravo
      2 - otoƒçen√≠  vzh≈Øru nohama
      3 - natoƒçen√≠ vlevo
   left - rotace smƒõrem doleva
  right - rotace smƒõrem doprava).
    180 - p≈ôetoƒçen√≠ o 180¬∞

Ka≈æd√° jin√° hodnota parametru je ignorov√°na."""
	local PAGES=$(djvuinfo "${1}")
	if [ "${PAGES}" == "none" ] ; then
		echo "jednostr√°nkov√Ω dokument - bude se ot√°ƒçet glob√°lnƒõ"
	else
		echo "v√≠cestr√°nkov√Ω dokument - bude se identifikovat str√°nka"
	fi

exit 0
	PAGE=$?
	NAMEPAGE=$(identifyname ${1} ${PAGE})
	if [ "${NAMEPAGE}" == "" ] ; then
		if [ "${3}" ] ; then
			echo "Nastavuji natoƒçen√≠ strany $PAGE cel√Ω dokument $1 - $2" >> /dev/stderr
			case "$3" in
				0|1|2|3)  ${DJVUSED} -e "select $PAGE; set-rotation $3; save" $1
				;;
				left) ${DJVUSED} -e "select $PAGE; set-rotation +1; save" $1
				;;
				right) ${DJVUSED} -e "select $PAGE; set-rotation -1; save" $1
				;;
				180) ${DJVUSED} -e "select $PAGE; set-rotation +2; save" $1
				;;
				*) echo "${INFO}" >> /dev/stderr
				;;
			esac
		else
			echo "Nastavuji glob√°ln√≠ natoƒçen√≠ pro cel√Ω dokument $1 - $2" >> /dev/stderr
			case "$2" in
				0|1|2|3)  ${DJVUSED} -e "set-rotation $2; save" $1
				;;
				left) ${DJVUSED} -e "set-rotation +1; save" $1
				;;
				right) ${DJVUSED} -e "set-rotation -1; save" $1
				;;
				180) ${DJVUSED} -e "set-rotation +2; save" $1
				;;
				*) echo "${INFO}" >> /dev/stderr
				;;
			esac
		fi
	else
		echo "Nastavuji glob√°ln√≠ natoƒçen√≠ pro cel√Ω dokument $1 - $2" >> /dev/stderr
		case "$2" in
			0|1|2|3)  ${DJVUSED} -e "set-rotation $2; save" $1
			;;
			left) ${DJVUSED} -e "set-rotation +1; save" $1
			;;
			right) ${DJVUSED} -e "set-rotation -1; save" $1
			;;
			180) ${DJVUSED} -e "set-rotation +2; save" $1
			;;
			*) echo "${INFO}" >> /dev/stderr
			;;
		esac
	fi
}

function forwardpage {
	# $1 - soubor
	# $2 - str√°nka k p≈ôesunu
	# $3 - pozice k p≈ôesunu
	local BORDER=$(identifypage $1 $3)
	if [ -z "${BORDER}" ] ; then
#		echo "Pouze se posouv√°, pokud nejde o kl√≠ƒçov√© slovo.."
		case "${3}" in
			end) # P≈ôesun na p≈ôedposledn√≠ pozici
				echo "ToDo" >> /dev/stderr && exit 0
			;;
			begin) # P≈ôesun na zaƒç√°tek souboru
				echo "ToDo" >> /dev/stderr && exit 0
			;;
			*) local AORDER=$(identifypage $1 $2)
				if [ -z "${AORDER}" ] ; then
					echo "Str√°nka $2 v souboru $1 nen√≠" >> /dev/stderr
					exit 1
				else
					echo "Nen√≠ jin√° pozice, bude se posouvat vp≈ôed" >> /dev/stderr
					if [ "${AORDER}" -gt "1" ] ; then
						local B=$(identifyname ${1} $((${AORDER} - 1)))
						local A=$(identifyname ${1} ${AORDER})
						echo "Strana $A se bude se p≈ôesouvat p≈ôed $B, mohu p≈ôikroƒçit k rozebr√°n√≠ a vyjmut√≠ str√°nky" >> /dev/stderr
						rozvazat ${1} ${TEMPDIR}
						deletepage ${1} ${A}
					else
						echo "Str√°nka $AORDER se ji≈æ nach√°z√≠ na prvn√≠ pozici" >> /dev/stderr
						exit 1
					fi
				fi
			;;
		esac
	else
		echo "pln√° - c√≠lov√° pozice, ƒçi str√°nka existuje. Je t≈ôeba zjistit, zda identifik√°tor nen√≠ v kolizi"
		local AORDER=$(identifypage $1 $2)
		if [ -z "${AORDER}" ] ; then
			echo "Str√°nka s identifik√°torem $2 v souboru $1 nen√≠" >> /dev/stderr
			exit 1
		else
			echo "Str√°nka vy se mohla p≈ôesouvat tak√© na sebe samu" >> /dev/stderr
			local B=$(identifyname $1 ${BORDER})
			local A=$(identifyname $1 ${AORDER})
			if [ "${B}" == "${A}" ] ; then
				echo "Identifik√°tor c√≠lov√© pozice odpov√≠d√° aktu√°ln√≠ pozici" >> /dev/stderr
				exit 1
			else
				echo "Mohu p≈ôikroƒçit k rozebr√°n√≠ a vyjmut√≠ str√°nky"
				rozvazat ${1} ${TEMPDIR}
				deletepage ${1} ${A}
			fi
		fi
	fi
	local BORDER=$(identifypage $1 $B)
	echo "Vkl√°d√°m str√°nku ${A} na pozici $BORDER"
	insertpage ${1} "${TEMPDIR}/${A}" ${BORDER}
}

function backpage {
	# $1 - soubor
	# $2 - str√°nka k p≈ôesunu
	# $3 - pozice k p≈ôesunu
	local P=$(identifypage $1 $2)
	AORDER=$P
	A=$(identifyname $1 $AORDER)
	local P=$(identifypage $1 $3)
	BORDER=$P
	if [ -z "${BORDER}" ] ; then
		if [ -z "${AORDER}" ] ; then
			echo "Str√°nka $2 v souboru nen√≠.."
			exit 1
		else
			B=$(identifyname $1 $((${AORDER} + 1)))
		fi
	else
		B=$(identifyname $1 ${BORDER})
	fi
	echo "forwardpage: P≈ôesouv√°m A -> $A p≈ôed B -> $B" >>/dev/stderr
	${DJVMCVT} -i ${1} ${TEMPDIR} index.djvu
	deletepage ${1} ${A}
	local P=$(identifypage $1 $B)
	insertpage ${1} "${TEMPDIR}/${A}" $(($P + 1))
}

function djvuinfo {
	# $1 - soubor
	# $2 - parametry
#	echo "djvuinfo: ${#@}" >> /dev/stderr
#	echo "djvuinfo: Soubor ${1}" >> /dev/stderr
#	echo "djvuinfo: Parametry ${2}" >> /dev/stderr
	# Ovƒõ≈ôuji, je-li soubor typu svazek..
	if $(identifybundle "${1}") ; then
		local PAGES="none"
	else
		local PAGES=$(lastpage "${1}")
	fi
	if [ -z "${2}" ] ; then
		echo "${PAGES}"
	else
		local INFO="DjVu pages"
		echo -n "${INFO}" && printf "%$((31 - ${#INFO}))s : ${PAGES}\n" >> /dev/stderr
		${EXIFTOOL} "${1}"
	fi
}

function djvubundle {
	# Funkce pro vytvo≈ôen√≠ svazku..
	# $1 - vzorek podle kter√©ho se maj√≠ vybrat soubory
	# $2 - c√≠lov√Ω DjVu soubor
	# $FORCE - ovliv≈àuje jestli se m√° p≈ôepsat c√≠lov√Ω soubor, nebo ne
	# $INDIRECT - ovliv≈àuje typ svazku
	# $EXTENSION - je p≈ô√≠pona v√Ωchoz√≠ch soubor≈Ø
	echo $@
	if [ -f "$1" ] ; then
		if [ -f "$2" ] ; then 
			if [ ${FORCE} == "no" ] ; then
				echo "pou≈æiju djvmcvt"
				help existed "$2"
				exit 0
			else
				${DJVMCVT} -${INDIRECT} "$1" "$2"
			fi
		fi
	else
		if [ -f "$2" ] ; then 
			if [ ${FORCE} == "no" ] ; then
				help existed "$2"
				exit 0
			else
				rm -rf "$2"
			fi
		fi
		if [ ${RENAME} == "no" ] ; then
			echo "V√Ωchoz√≠ soubory jsou identifikov√°ny vzorkem a nep≈ôejmenuj√≠ se"
			for i in $(ls -1 | grep -E "([0-9])\1?$EXTENSION\$" | sed "s/$1//" | sort -n) ; do
				#echo "$2 $1$i"
				ORIGSOUBOR="$1$i"
				DJVUSOUBOR=${ORIGSOUBOR/$EXTENSION/.djvu}
				if [ -f "$ORIGSOUBOR" ] ; then
					if [ ! -f "$DJVUSOUBOR" ] ; then
						todjvu "$ORIGSOUBOR"
					fi
				fi
				if [ -f "$2" ] ; then
					${DJVM} -i "$2" "$DJVUSOUBOR"
				else
					${DJVM} -c "$2" "$DJVUSOUBOR"
				fi
			done 
		else
#		RENAME
			if [ "${RENAME}" == "0" ] ; then
				#echo "numerick√© ƒç√≠slov√°n√≠, n√°zev soubor≈Ø se - a≈æ na ƒç√≠slo zachov√° "
				INPUT=""
					for i in $(ls -1 $1*${EXTENSION} ) ; do
						if [ "$INPUT" == "" ] ; then
							INPUT="${i%%+([0-9${EXTENSION}.])}"
						elif [ "$INPUT" != "${i%%+([0-9${EXTENSION}.])}" ] ; then
							continue
						else
							echo "zpracuji $i" > /dev/null
						fi
						STRING="${i#${INPUT}}"
						RAWNUMBER="${STRING%${EXTENSION}}"
						NUMBER="${RAWNUMBER##+(0)}"
						if [ "${NUMBER}" == "" ] ; then
							TARGET="${INPUT}0${EXTENSION}"
						else
							TARGET="${INPUT}${NUMBER}${EXTENSION}"
						fi
						if [ "$3" ] ; then
							if [ "$TARGET" == "${VZOR}$3${EXTENSION}" ] ; then
								konvertor "$i" "${TARGET/${EXTENSION}/.djvu}"
							fi
						else
							konvertor "$i" "${TARGET/${EXTENSION}/.djvu}"
						fi
					done
#					echo "NUMERIC - soubor stejn√Ω"
			elif [ ! "${RENAME//0/}" ] ; then
				MAX="0"
					for i in $(ls -1 $1*${EXTENSION} ) ; do
						if [ "$INPUT" == "" ] ; then
							INPUT="${i%%+([0-9${EXTENSION}.])}"
						elif [ "$INPUT" != "${i%%+([0-9${EXTENSION}.])}" ] ; then
							continue
						else
							echo "zpracuji $i" > /dev/null
						fi
						STRING="${i#${INPUT}}"
						RAWNUMBER="${STRING%${EXTENSION}}"
						if [ "${#RAWNUMBER}" -gt  "${#MAX}" ] ; then
							MAX="${RAWNUMBER}"
						fi
					done
				if [ "${#MAX}" -gt "${#RENAME}" ] ; then
					BASE="${MAX//[0-9]/0}"
				else
					BASE="${RENAME}"
				fi
				INPUT=""
					for i in $(ls -1 $1*${EXTENSION} ) ; do
						if [ "$INPUT" == "" ] ; then
							INPUT="${i%%+([0-9${EXTENSION}.])}"
						elif [ "$INPUT" != "${i%%+([0-9${EXTENSION}.])}" ] ; then
							continue
						else
							echo "zpracuji $i" > /dev/null
						fi
						STRING="${i#${INPUT}}"
						RAWNUMBER="${STRING%${EXTENSION}}"
						NUMBER="${RAWNUMBER##+(0)}"
						if [ "${NUMBER}" == "" ] ; then
							TARGET="${INPUT}${BASE}${EXTENSION}"
						else
							TARGET="${INPUT}${BASE:0:$((${#BASE} - ${#NUMBER}))}${NUMBER}${EXTENSION}"
						fi
						if [ "$3" ] ; then
							if [ "$TARGET" == "${VZOR}$3${EXTENSION}" ] ; then
								konvertor "$i" "${TARGET/${EXTENSION}/.djvu}"
							fi
						else
							konvertor "$i" "${TARGET/${EXTENSION}/.djvu}"
						fi
					done
#				echo "BASE - soubor stejn√Ω"
			else
				# VZOR + BASE z RENAME
				VZOR="${RENAME%%+(0)}"
				BASE="${RENAME#$VZOR}"
				if [ "${#BASE}" == "1" ] ; then
					INPUT=""
					for i in $(ls -1 $1*${EXTENSION} ) ; do
						if [ "$INPUT" == "" ] ; then
							INPUT="${i%%+([0-9${EXTENSION}.])}"
						elif [ "$INPUT" != "${i%%+([0-9${EXTENSION}.])}" ] ; then
							continue
						else
							echo "zpracuji $i" > /dev/null
						fi
						STRING="${i#${INPUT}}"
						RAWNUMBER="${STRING%${EXTENSION}}"
						NUMBER="${RAWNUMBER##+(0)}"
						if [ "${NUMBER}" == "" ] ; then
							TARGET="${VZOR}0${EXTENSION}"
						else
							TARGET="${VZOR}${NUMBER}${EXTENSION}"
						fi
						if [ "$3" ] ; then
							if [ "$TARGET" == "${VZOR}$3${EXTENSION}" ] ; then
								konvertor "$i" "${TARGET/${EXTENSION}/.djvu}"
							fi
						else
							konvertor "$i" "${TARGET/${EXTENSION}/.djvu}"
						fi
					done
#					echo "NUMERIC - vzor"
				else
					INPUT=""
					MAX="0"
					for i in $(ls -1 $1*${EXTENSION} ) ; do
						if [ "$INPUT" == "" ] ; then
							INPUT="${i%%+([0-9${EXTENSION}.])}"
						elif [ "$INPUT" != "${i%%+([0-9${EXTENSION}.])}" ] ; then
							echo "Soubor $i nevyhovuje zvolen√©mu vzoru $1 p≈ôeskakuji jej" >> /dev/stderr
							continue
						else
							echo "zpracuji $i" > /dev/null
						fi
						STRING="${i#${INPUT}}"
						RAWNUMBER="${STRING%${EXTENSION}}"
						if [ "${#RAWNUMBER}" -gt  "${#MAX}" ] ; then
							MAX="${RAWNUMBER}"
						fi
					done
					ORIGBASE="${MAX//[0-9]/0}"
					if [ "${#ORIGBASE}" -gt "${#BASE}" ] ; then
						BASE="$ORIGBASE"
						echo "ORIGBASE - vzor"
					fi
					#	Seznam set≈ô√≠dƒõn√Ω podle d√©lky ≈ôetƒõzc≈Ø $(ls -1 $1* | grep -E "([0-9])\1?$EXTENSION\$" | sed "s/$1//" | sort -n)
					# for i in $(ls -1 | grep -E "([0-9])\1?$EXTENSION\$" | awk '{ print length, $0 }' | sort -n ) ; do
					INPUT=""
					for i in $(ls -1 $1*${EXTENSION} ) ; do
						if [ "$INPUT" == "" ] ; then
							INPUT="${i%%+([0-9${EXTENSION}.])}"
						elif [ "$INPUT" != "${i%%+([0-9${EXTENSION}.])}" ] ; then
							continue
						else
							echo "zpracuji $i" > /dev/null
						fi
						STRING="${i#${INPUT}}"
						RAWNUMBER="${STRING%${EXTENSION}}"
						NUMBER="${RAWNUMBER##+(0)}"
						if [ "${NUMBER}" == "" ] ; then
							TARGET="${VZOR}${BASE}${EXTENSION}"
						else
							TARGET="${VZOR}${BASE:0:$((${#BASE} - ${#NUMBER}))}${NUMBER}${EXTENSION}"
						fi
						if [ "$3" ] ; then
							if [ "$TARGET" == "${VZOR}$3${EXTENSION}" ] ; then
								konvertor "$i" "${TARGET/${EXTENSION}/.djvu}"
							fi
						else
							konvertor "$i" "${TARGET/${EXTENSION}/.djvu}"
						fi
					done
#					echo "VZOR BASE"
				fi
			fi
		fi
	fi
}

function fromxcf {
	if [ "${1##*.}" == "xcf" ] ; then
		TEMPORARY="/tmp/$WINDOWID$BASHPID"
		mkdir $TEMPORARY
		convert ${1} ${TEMPORARY}/test.png
		pushd $TEMPORARY
			BUNDLE=" "
			for i in $(ls -cr -1) ; do
				todjvu $i
				BUNDLE="$BUNDLE ${i/.png/.djvu}"
			done
			djvm -c out.djvu $BUNDLE
		popd
		mv $TEMPORARY/out.djvu ./
		rm -rf $TEMPORARY
	fi
}

function help {
	echo -n """[1mN√°povƒõda pro [1m[2m${0##*/}[0m : """
	case "$1" in
		exporttodjvu) echo """volba [1m-p[0m ([1m--page[0m)

  Extrakce DjVu str√°nky ze svazku

  [1m${0##*/}[0m ... {-p|--page} [yes|no] ...
  
  Prost≈ôednictv√≠m t√©to volby lze zvolit zda se m√°, nebo nem√° p≈ôi akci
  [3mexport[23m z DjVu svazku exportovat i cel√° DjVu str√°nka. Pokud za volbou
  nen√°sleduje parametr, pak se automaticky p≈ôedpokl√°d√° ≈æe ano (yes).
  V√Ωchoz√≠ nastaven√≠ (no), lze implicitnƒõ zmƒõnit prost≈ôednictv√≠m
  u≈æivatelsk√©ho konfiguraƒçn√≠ho souboru um√≠stƒõn√©ho v v adres√°≈ôi:

    ${HOME}/.config/${NAME}/
"""
		;;
		exporttopng) echo """volba [1m[1m--img[0m

  [4mExtrakce obrazov√© vrstvy[24m DjVu str√°nky do bitmapov√©ho souboru

  [1m${0##*/}[0m ... --img [yes|no|<layer>] ...

  Je-li parametrem volby [3myes[23m, tak se bude p≈ôi akci [2mexport[22m generovat z DjVu
  str√°nky plnobarevn√Ω bitmapov√Ω obr√°zek ve form√°tu PNG.
  V ostatn√≠ch p≈ô√≠padech bude ve form√°tu PNM.

      [1m${0##*/}[0m --img background svazek.djvu export stranka.djvu
 
Pou≈æiteln√© parametry:
                 color - plnobarevn√° str√°nka
                 black - ƒçernob√≠l√° kresba
            foreground - vrstva pop≈ôed√≠
            background - vrstva pozad√≠
                  mask - maska
  Je-li m√≠sto [3m'yes'[23m uvedeno [3m'background'[23m, bude p≈ôi exportu str√°nky
  strana.djvu ulo≈æen obr√°zek pozad√≠ pod jm√©nem strana.background.pnm
  V√Ωchoz√≠ nastaven√≠ lze implicitnƒõ zmƒõnit nastaven√≠m promƒõnn√© IMGPAGE
"""
		;;
		exporttoxml) echo """volba [1m-x[0m ([1m--xml[0m)

  Extrakce DjVu str√°nky ze svazku

  [1m${0##*/}[0m ... {-x|--xml} [yes|no] ...
  
  Prost≈ôednictv√≠m t√©to volby lze zvolit zda se m√°, nebo nem√° p≈ôi akci
  [3mexport[23m z DjVu svazku exportovat i cel√° DjVu str√°nka. Pokud za volbou
  nen√°sleduje parametr, pak se automaticky p≈ôedpokl√°d√° ≈æe ano (yes).
  V√Ωchoz√≠ nastaven√≠ (no), lze implicitnƒõ zmƒõnit prost≈ôednictv√≠m
  u≈æivatelsk√©ho konfiguraƒçn√≠ho souboru um√≠stƒõn√©ho v v adres√°≈ôi:

    ${HOME}/.config/${NAME}/
"""
		;;
		exporttodsed) echo """volba [1m-d[0m ([1m--dsed[0m)

  Extrakce DjVu str√°nky ze svazku

  [1m${0##*/}[0m ... {-x|--xml} [yes|no] ...
  
  Prost≈ôednictv√≠m t√©to volby lze zvolit zda se m√°, nebo nem√° p≈ôi akci
  [3mexport[23m z DjVu svazku exportovat i cel√° DjVu str√°nka. Pokud za volbou
  nen√°sleduje parametr, pak se automaticky p≈ôedpokl√°d√° ≈æe ano (yes).
  V√Ωchoz√≠ nastaven√≠ (no), lze implicitnƒõ zmƒõnit prost≈ôednictv√≠m
  u≈æivatelsk√©ho konfiguraƒçn√≠ho souboru um√≠stƒõn√©ho v v adres√°≈ôi:

    ${HOME}/.config/${NAME}/
"""
		;;
		exporttometa) echo """volba [1m-m[0m ([1m--meta[0m)

  Extrakce DjVu str√°nky ze svazku

  [1m${0##*/}[0m ... {-x|--xml} [yes|no] ...
  
  Prost≈ôednictv√≠m t√©to volby lze zvolit zda se m√°, nebo nem√° p≈ôi akci
  [3mexport[23m z DjVu svazku exportovat i cel√° DjVu str√°nka. Pokud za volbou
  nen√°sleduje parametr, pak se automaticky p≈ôedpokl√°d√° ≈æe ano (yes).
  V√Ωchoz√≠ nastaven√≠ (no), lze implicitnƒõ zmƒõnit prost≈ôednictv√≠m
  u≈æivatelsk√©ho konfiguraƒçn√≠ho souboru um√≠stƒõn√©ho v v adres√°≈ôi:

    ${HOME}/.config/${NAME}/
"""
		;;
		exporttothumb) echo """volba [1m-t[0m ([1m--thumb[0m)

  Extrakce DjVu str√°nky ze svazku

  [1m${0##*/}[0m ... {-t|--thumb} [yes|no] ...
  
  Prost≈ôednictv√≠m t√©to volby lze zvolit zda se m√°, nebo nem√° p≈ôi akci
  [3mexport[23m z DjVu svazku exportovat i cel√° DjVu str√°nka. Pokud za volbou
  nen√°sleduje parametr, pak se automaticky p≈ôedpokl√°d√° ≈æe ano (yes).
  V√Ωchoz√≠ nastaven√≠ (no), lze implicitnƒõ zmƒõnit prost≈ôednictv√≠m
  u≈æivatelsk√©ho konfiguraƒçn√≠ho souboru um√≠stƒõn√©ho v v adres√°≈ôi:

    ${HOME}/.config/${NAME}/
"""
		;;
		force) echo """volba [1m-f[0m ([1m--force[0m)

  Vynucen√≠ akce

  [1m${0##*/}[0m ... {-f|--force} ...
  
  Prost≈ôednictv√≠m t√©to volby si lze vynutit realizaci akce.
  V√Ωchoz√≠ nastaven√≠ (no), lze implicitnƒõ zmƒõnit na (yes) prost≈ôednictv√≠m
  u≈æivatelsk√©ho konfiguraƒçn√≠ho souboru um√≠stƒõn√©ho v v adres√°≈ôi:

    ${HOME}/.config/${NAME}/
"""
		;;
		indirect) echo"""
[1mVolba[0m
         --indirect Volba, kterou lze zmƒõnit v√Ωchoz√≠ typ v√≠cestr√°nkov√©ho 
                    DjVu svazku (bundeled)

  Volbu je t≈ôeba aplikovat pokud chcete rozbalit stv√°vaj√≠c√≠ DjVu svazek 
  do podoby voln√©ho svazku, nebo pokud chcete p≈ôi konverzi bitmapov√Ωch
  soubor≈Ø rovnou sestavit DjVu svazek jako voln√Ω

  V√Ωhodou voln√©ho svazku je, ≈æe lze dodateƒçnƒõ upravovat jednotliv√© str√°nky
  jako samostatn√© DjVu soubory, ani≈æ by je bylo nutn√© exportovat.

  Pro finalizaci DjVu svazku je pak lep≈°√≠ svazek p≈ôekonvertovat na typ
  bundled, kdy je v≈°e zabaleno v jednom souboru
"""
		;;
		existed) echo """
  Soubor $2 existuje. Pokud se m√° p≈ôepsat, mus√≠ b√Ωt
  uveden parametr -f (--force)
"""
		;;
		dpi) echo"""
[1mParametr[0m
         --dpi  <[2mƒç√≠slo[22m> Hodnota DPI, kter√° se m√° pou≈æ√≠t p≈ôi zpracov√°n√≠ obr√°zku.
                               p≈ôi konverzi. Optim√°ln√≠ je zjistit hodnotu p≈ô√≠mo ze vstupn√≠ho
                               obr√°zku. P≈ôed nastaven√≠m t√©to hodnoty pro fin√°ln√≠ konverzi. lze vyzkou≈°et
                               optim√°ln√≠ nastaven√≠ na nƒõkter√©m ze soubor≈Ø s vyu≈æit√≠m parametru
                               --test

  Rozsah ƒç√≠seln√© hodnoty je od 72 do 6000 dpi. V√Ωchoz√≠ hodnota 300 se pou≈æije 
  v p≈ô√≠padƒõ, ≈æe parametr --dpi nen√≠ v≈Øbec uveden.
  Vliv dpi na zpracov√°n√≠ obrazu..
"""
		;;
		level) echo"""
[1mParametr[0m
         -l|--level  <[2mƒç√≠slo[22m> Hodnota akceptovateln√Ωch ztr√°t u ƒçernob√≠l√© kresby
                               p≈ôi konverzi. P≈ôed nastaven√≠m t√©to hodnoty vyzkou≈°ejte
                               optim√°ln√≠ nastaven√≠ na nƒõkter√©m ze soubor≈Ø a s parametrem
                               --test

  Kromƒõ ƒç√≠seln√© hodnoty, kter√° mus√≠ b√Ωt men≈°√≠ ne≈æ 200 lze √∫rove≈à ztr√°t
  nastavit i pomoc√≠ nƒõkter√©ho z n√°sleduj√≠c√≠ch parametr≈Ø - v p≈ô√≠padƒõ ≈æe 
  jich bude uvedeno v√≠c, m√° prioritu posledn√≠ z nich.

        --lossless     0 - ≈æ√°dn√© ztr√°ty (default)
        --clean        1 - ignoruj√≠ se body o velikosti 1 pixelu
        --lossy        100 - ignoruj√≠ se plochy
"""
		;;
		keywords-export) echo """vytvo≈ôen√≠ xml, dsed a n√°hledu
  Export n√°hledu a textov√©ho obsahu DjVu souboru do extern√≠ch soubor≈Ø.

[1mSyntaxe[0m

  [1m${0##*/}[0m [volby] <svazek> export {<num>|<name>|all} [<dir>]

         num  - po≈ôadov√© ƒç√≠slo str√°nky v DjVu svazku
         name - jm√©no str√°nky v DjVu svazku
         dir  - adres√°≈ô do kter√©ho m√° b√Ωt v√Ωstup ulo≈æen

[3mPozn√°mka:[23m
  Je-li m√≠sto po≈ôadov√©ho ƒç√≠sla str√°nky, nebo jej√≠ho n√°zvu, uvedeno all tak
  se bude exportovat obsah textov√Ωch vrstev cel√©ho DjVu svazku.
  Form√°t exportovan√©ho souboru je ve v√Ωchoz√≠m stavu .xml, ale s vyu≈æit√≠m 
  volby -d (--dsed) lze textovou vrstvu exportovat i ve form√°tu pro djvused.
  Je-li uveden tak√© parametr --thumb, bude vyexportov√°n i n√°hled v .png
  Nen√≠-li uveden adres√°≈ô, je pou≈æit aktu√°ln√≠ adres√°≈ô. Pro pojmenov√°n√≠ soubor≈Ø
  je vyu≈æit n√°zev str√°nky v takov√© podobƒõ, jak je ulo≈æen v DjVu svazku.
  Pokud ji≈æ soubory se stejn√Ωm n√°zvem v adres√°≈ôi existuj√≠, lze si vynutit
  jejich p≈ôeps√°n√≠ volbou -f (--force)
"""
		;;
		keywords-import) echo """
  Import textov√©ho obsahu DjVu souboru z extern√≠ch soubor≈Ø

[1mSyntaxe[0m

  [1m${0##*/}[0m [volby] <svazek> import <file> [<num>|<name>]

         num  - po≈ôadov√© ƒç√≠slo str√°nky v DjVu svazku
         name - jm√©no str√°nky v DjVu svazku
         file - soubor s obsahem skryt√© textov√© vrstvy

[3mPozn√°mka:[23m
  Nen√≠-li uvedeno po≈ôadov√© ƒç√≠slo str√°nky, nebo jej√≠ n√°zev, tak se p≈ôedpokl√°d√°
  ≈æe jde o obsah textov√© vrstvy cel√©ho DjVu svazku.
  Soubor je rozli≈°en√Ω podle p≈ô√≠pony a m≈Ø≈æe to b√Ωt buƒè v .dsed nebo .xml
  form√°tu.
  Touto cestou lze importovat tak√© XMP informace z .xmp souboru
"""
		;;
		keywords-delete) echo """akce [1mdelete[0m

  [4mOdstranƒõn√≠ str√°nky[24m identifikovan√© jm√©nem, nebo pozic√≠ v DjVu svazku

  [1m${0##*/}[0m [volby] <svazek> delete {<num>|<name>}

         num  - po≈ôadov√© ƒç√≠slo str√°nky v DjVu svazku
         name - jm√©no str√°nky v DjVu svazku

[1mD√°vejte pozor[0m - akce je nevratn√° !
  Je doporuƒçeno p≈ôi odstra≈àov√°n√≠ str√°nek pou≈æ√≠t jako identifik√°tor jm√©no
  str√°nky. A to z toho d≈Øvodu, ≈æe se pozice str√°nky m≈Ø≈æe v pr≈Øbƒõhu
  zpracov√°n√≠ DjVu svazku zmƒõnit, kde≈æto jej√≠ jm√©no z≈Øst√°v√° v≈ædy v r√°mci
  svazku jedineƒçn√©.
"""
		;;
		keywords-info) echo """akce [1minfo[0m

  [4mV√Ωpis informac√≠ o DjVu souboru[24m.

  [1m${0##*/}[0m [volby] <file> info [<num>|<name>]

         num  - po≈ôadov√© ƒç√≠slo str√°nky v DjVu svazku
         name - jm√©no str√°nky v DjVu svazku
         file - jm√©no DjVu souboru
"""
		;;
		keywords-insert) echo """akce [1minsert[0m
  [4mVlo≈æen√≠ DjVu souboru do Djvu svazku[24m. Je-li na vstupu nekonvertovovan√Ω
  obr√°zek, dojde ke konverzi. Nen√≠-li uvedena pozice, ƒçi jm√©no str√°nky p≈ôed 
  kterou se m√° obsah vlo≈æit, p≈ôipoj√≠ se na konec DjVu svazku. P≈ôedt√≠m, je ale vy≈æadov√°no potvrzen√≠ akce, kter√© lze obej√≠t pouze pou≈æit√≠m volby -f (--force)

  [1m${0##*/}[0m [volby] <svazek> insert <file> [<num>|<name>]

         num  - po≈ôadov√© ƒç√≠slo str√°nky v DjVu svazku
         name - jm√©no str√°nky v DjVu svazku
         file - jm√©no DjVu souboru, nebo skenu

[3mPozn√°mka:[23m
  Pokud se ji≈æ v DjVu souboru str√°nka se stejn√Ωm n√°zvem vyskytuje, dojde
  p≈ôi vlo≈æen√≠ k p≈ôejmenov√°n√≠ souboru - za n√°zev se p≈ôid√° podtr≈æ√≠tko
  a po≈ôadov√© ƒç√≠slo v√Ωskytu. K takov√© situaci m≈Ø≈æe doj√≠t tak√© v p≈ô√≠padƒõ,
  ≈æe je operace [2minsert[22m zopakov√°na se stejn√Ωmi parametry. Pak se
  automaticky p≈ôid√°van√© ƒç√≠slo postupnƒõ navy≈°uje.

              insert test01.jpg => test01.djvu
              insert test01.jpg => test01_1.djvu
              insert test01.jpg => test01_2.djvu
              ...
"""
		;;
		keywords-forward) echo """akce [1mforward[0m

  P≈ôesun str√°nky v r√°mci DjVu svazku o pozici vp≈ôed. [4mP≈ôed str√°nku, kter√°[24m
  [4mji m√° n√°sledovat[24m. V p≈ô√≠padƒõ, u≈æ p≈ôesouvan√° str√°nka je na prvn√≠ pozici,
  se nestane nic.

  [1m${0##*/}[0m [volby] <svazek> fore {<num>|<name>} [<num>|<name>]

         num  - po≈ôadov√© ƒç√≠slo str√°nky v DjVu svazku
         name - jm√©no str√°nky v DjVu svazku

  Je doporuƒçeno pou≈æ√≠t jako identifik√°tor jm√©na str√°nek, m√≠sto jejich 
  aktu√°ln√≠ pozice. A to z toho d≈Øvodu, ≈æe se pozice str√°nek mohou v pr≈Øbƒõhu
  zpracov√°n√≠ DjVu svazku mƒõnit, kde≈æto jej√≠ jm√©no str√°nky je v≈ædy v r√°mci
  svazku jedineƒçn√©.
"""
		;;
		keywords-back) echo """akce [1mback[0m

  P≈ôesun str√°nky v r√°mci DjVu svazku o pozici zpƒõt. [4mZa str√°nku, kter√°[24m
  [4mji m√° n√°sledovat[24m. V p≈ô√≠padƒõ, u≈æ je p≈ôesouvan√° str√°nka na posledn√≠ pozici,
  se nestane nic.

  [1m${0##*/}[0m [volby] <svazek> back {<num>|<name>} [<num>|<name>]

         num  - po≈ôadov√© ƒç√≠slo str√°nky v DjVu svazku
         name - jm√©no str√°nky v DjVu svazku

  Je doporuƒçeno pou≈æ√≠t jako identifik√°tor jm√©na str√°nek, m√≠sto jejich 
  aktu√°ln√≠ pozice. A to z toho d≈Øvodu, ≈æe se pozice str√°nek mohou v pr≈Øbƒõhu
  zpracov√°n√≠ DjVu svazku mƒõnit, kde≈æto jej√≠ jm√©no str√°nky je v≈ædy v r√°mci
  svazku jedineƒçn√©.
"""
		;;
		keywords-rotate) echo """akce [1mrotate[0m

  [4mOtoƒçen√≠ DjVu str√°nky[24m.

  [1m${0##*/}[0m [volby] <svazek> rotate {<num>|<name>} <value>

         num   - po≈ôadov√© ƒç√≠slo str√°nky
         name  - jm√©no str√°nky
         value - parametr jak m√° b√Ωt str√°nka natoƒçena

[1mParametry[0m
  O - nastav√≠ str√°nku do v√Ωchoz√≠ pozice
  1 - natoƒç√≠ str√°nku o 90¬∞ vpravo
  2 - natoƒç√≠ str√°nku vz≈Øru nohama 
  3 - natoƒç√≠ str√°nku o 90¬∞ vlevo
  left - pootoƒç√≠ str√°nku o 90¬∞ smƒõrem doleva
  right - pootoƒç√≠ str√°nku o 90¬∞ smƒõrem doprava
  180 - pootoƒç√≠ str√°nku o 180¬∞

[3mPozn√°mka:[23m
          Nen√≠-li uveden identifik√°tor str√°nky, je parametrem
          nastaveno glob√°ln√≠ natoƒçen√≠ cel√©ho dokumentu.
"""
		;;
		keywords-set) echo """akce [1mset[0m

  [4mNastaven√≠ meta atribut≈Ø[24m DjVu str√°nky, resp. cel√©ho svazku

  [1m${0##*/}[0m [volby] <svazek> set {<num>|<name>} {<file>|<key> <value>}

  [1m${0##*/}[0m [volby] <svazek> set {<file>|<key> <value>}

         num   - po≈ôadov√© ƒç√≠slo str√°nky
         name  - jm√©no str√°nky
         file  - soubor s meta atributy
         key   - jm√©no meta atributu
         value - hodnota meta atributu

Nejbƒõ≈ænƒõj≈°√≠ atributy (key):
       Title - N√°zev DjVu dikumentu
     Creator - Jm√©no tv≈Ørce DjVu dokumentu
CreationDate - ƒåas vytvo≈ôen√≠ dokumentu
    Keywords - Kl√≠ƒçov√° slova pro indexaci DjVu dokumentu
      annote - Pozn√°mka k dokumentu

[3mPozn√°mka:[23m
  Dal≈°√≠ viz akce [2mprint[22m, [2mexport[22m, [2mimport[22m, [2munset[22m a manu√°l k tomuto skriptu.
"""
		;;
		keywords-unset) echo """akce [1munset[0m

  [4mOdstranƒõn√≠ meta atribut≈Ø[24m DjVu str√°nky, resp. cel√©ho svazku

  [1m${0##*/}[0m [volby] <svazek> unset {<num>|<name>} <key>

  [1m${0##*/}[0m [volby] <svazek> unset <key>

         num   - po≈ôadov√© ƒç√≠slo str√°nky
         name  - jm√©no str√°nky
         key   - jm√©no meta atributu

[1mD√°vejte pozor[0m - akce je nevratn√° !
  Akce dovoluje odstranit nejenom vybran√Ω atribut, ale tak√© v≈°echny dal≈°√≠,
  proto ji vyu≈æ√≠vejte nanejv√Ω≈° opatrnƒõ. S meta atributy pracujte radƒõji
  prost≈ôednictv√≠m soubor≈Ø zpracov√°van√Ωch p≈ôi akc√≠ch [2mexport[22m a [2mimport[22m.
  Pro ovƒõ≈ôen√≠ kl√≠ƒçe, p≈ôed jeho zru≈°en√≠m vyu≈æijte akci [2mprint[22m. Nov√Ω obsah
  kl√≠ƒçe lze nastavit p≈ôes akci [2mset[22m.
"""
		;;
		keywords-print) echo """akce [1mprint[0m

  [4mV√Ωpis kl√≠ƒç≈Ø a jejich obsahu[24m z metainformac√≠ ulo≈æen√Ωch v Djvu svazku.

  [1m${0##*/}[0m <svazek> print [all]
  [1m${0##*/}[0m <svazek> print <attr>
  [1m${0##*/}[0m <svazek> print {<num>|<name>} [all]
  [1m${0##*/}[0m <svazek> print {<num>|<name>} <attr>

         num  - po≈ôadov√© ƒç√≠slo str√°nky v DjVu svazku
         name - jm√©no str√°nky v DjVu svazku
         attr - jm√©no atributu
         all  - kl√≠ƒçov√© slovo (vypsat v≈°e)

[3mPozn√°mka:[23m
  Jednotliv√© atributy lze nastavovat p≈ôes [2mset[22m, v√≠ce atribut≈Ø najednou
  lze do DjVu str√°nky ƒçi svazku importovat z extern√≠ho souboru p≈ôi
  akci [2mimport[22m. Metadata lze z DjVu soubor≈Ø tak√© exportovat ([2mexport[22m).
"""
		;;
		keywords) echo """
  [1m${0##*/}[0m [volby] {DjVu svazek} <keyword> [-h|...]

  [1m      keyword - popis akce[0m

         delete - odstran√≠ str√°nku ze svazku
         insert - vlo≈æ√≠ novou str√°nku do svazku
     fore, back - p≈ôesune str√°nku v r√°mci svazku
         rotate - mƒõn√≠ orientaci vybran√© str√°nky
            set - nastavuje metainformace DjVu str√°nek a svazku
          print - vypisuje metainformace z DjVu str√°nek a svazku
          unset - odstra≈àuje metainformace DjVu str√°nek i svazku
         export - exportuje djvu str√°nku, dsed nebo xml soubor s obsahem
                  textov√© vrstvy, n√°hled str√°nky v png, atp.
         import - importuje do DjVu str√°nky ƒçi svazku obsah skryt√© textov√©
                  vrstvy z xml str√°nky
         rename - p≈ôejmenov√°n√≠ str√°nek v DjVu souboru dle nastaven√©ho vzoru

[3mPozn√°mka:[23m
          Pro podrobnƒõj≈°√≠ n√°povƒõdu pou≈æijte volbu -h za kl√≠ƒçov√Ωm slovem
"""
		;;
		rename) echo """
[1mParametr[0m
         -r|--rename  <[2mvzor[22m>  Vzor, podle jak√©ho se maj√≠ p≈ôejmenovat
                              d√≠lƒç√≠ DjVu soubory, ze kter√Ωch se pak bude
                              sestavovat DjVu svazek.
[4mPopis:[24m
  Pomoc√≠ [2mvzoru[22m lze upravit n√°zvy zkonvertovan√Ωch DjVu soubor≈Ø
  p≈ôed jejich sestaven√≠m do DjVu svazku. [2mVzor[22m m≈Ø≈æe b√Ωt tvo≈ôen:
    1, Pouze jednou, nebo v√≠ce nulami - 000
    2, Nebo ≈ôetƒõzcem, n√°sledovan√Ωm nulami - soubor_00

[3mPozn√°mka:[23m
  Je-li uvedena pouze jedna nula, budou str√°nky oƒç√≠slov√°ny [4mnumericky[24m,
  t.j. od ƒç√≠sla 1 d√°le. Je-li nul v√≠ce, pak bude ƒç√≠slo interpretov√°no
  jako [4m≈ôetƒõzec[24m. tedy 001 a d√°le. Pokud by ƒç√≠slov√°n√≠ str√°nek p≈ôes√°hlo
  nastaven√Ω poƒçet ƒç√≠sel, bude upraven dle maxim√°ln√≠ho ƒç√≠sla.

[3mUk√°zkov√© vzory : a v√Ωsledn√Ω efekt..[23m
   soubor-0000 : soubor-0001.djvu .. soubor-0123.djvu
   soubor_0    : soubor_1.djvu    .. soubor_123.djvu
   soubor000   : soubor0001.djvu  .. soubor1234.djvu
"""
			;;
		suffix) echo """
[1mParametr[0m
         -e|--ext  <[2msuffix[22m>  P≈ô√≠pona soubor≈Ø, ze kter√Ωch se m√° sestavit 
                                DjVu soubor.
[4mPopis:[24m
  [2mSuffix[22m je nutn√© uv√©st pouze v p≈ô√≠padƒõ, ≈æe soubory s n√°zvem odpov√≠daj√≠c√≠m
  vzorku dosud nebyly do DjVu zkonvertov√°ny. Jinak se v≈ædy p≈ôedpokl√°d√°, ≈æe
  se bude pracovat s ji≈æ konvertovan√Ωmi DjVu soubory.

  Je-li [2msuffix[22m uveden, budou konvertov√°ny soubory vyhovuj√≠c√≠ vzorku.
  Pokud nƒõkter√© z nich ji≈æ konvertov√°ny byly, tak se se f√°ze konverze
  p≈ôeskoƒç√≠. Pracuje se pak s ji≈æ existuj√≠c√≠m DjVu souborem.

  Konvertov√°ny jsou pouze soubory, kter√© chyb√≠. Kvalitu konverze lze
  ovlivnit  dal≈°√≠mi parametry. Maj√≠-li b√Ωt soubory p≈ôekonvertov√°ny znovu,
  lze si to vynutit parametrem -f (--force) a st√°vaj√≠c√≠ soubory  p≈ôepsat.

  Akceptovan√© sufixy: 
     djvu (default), jpg, gif, png, bmp, pnm, pbm, pgm.
  V√≠cevrstv√© soubory:
     xcf, tiff, pdf 
"""
			;;
		options) echo """
[1mP≈ôehled akceptovan√Ωch voleb[0m: 
  -h|--help     N√°povƒõda
  -b|--bundle   V√Ωsledekm zpracov√°n√≠ bude kompaktn√≠ svazek ( default)
  -d|--dsed     P≈ôi akci export ukl√°dat obsah textov√© vrstvy do souboru .dsed
  -f|--force    Vynucen√≠ akce
  -i|--indirect V√Ωsledekm zpracov√°n√≠ bude voln√Ω svazek
  -m|--meta     P≈ôi akci export ukl√°dat meta informace z DjVu str√°nky ƒçi svazku do soubor s p≈ô√≠ponou .meta
  -p|--page     Vyta≈æen√≠ cel√© str√°nky z DjVu svazku
  -x|--xml      P≈ôi akci export ukl√°dat obsah textov√© vrstvy do souboru .xml
  -t|--thumb    Vygenerov√°n√≠ n√°hled≈Ø v DjVu svazku, resp. p≈ôi akci export vyta≈æen√≠ n√°hledu do souboru s p≈ô√≠ponou .thumb (obrazov√° vrstva, k√≥dvan√° v  IW44)

Parametrick√© volby:
   -n|--name    parametr zajist√≠, ≈æe se soubory p≈ôejmenuj√≠
   -r|--rename  ≈ôetƒõzec, kter√Ω se m√° pou≈æ√≠t k pojmenov√°n√≠ soubor≈Ø m√≠sto 
                st√°vaj√≠c√≠ch n√°zv≈Ø soubor≈Ø p≈ôi sestaven√≠ svazku 
                soubor_0000 - soubor_0001.djvu .. soubor_0123.djvu
                soubor_0 -    soubor_1.djvu ,, soubor_123.djvu
"""
		;;
		*) echo """
   Toto je n√°stroj pro pr√°ci s DjVu soubory a svazky.

      [1m${0##*/}[0m [volby] ... <akce>

 N√°povƒõdu k volb√°m a jejich parametr≈Øm vyp√≠≈°e volba -h
 P≈ôehled v≈°ech dostupn√Ωch voleb vyp√≠≈°ete takto...

      [1m${0##*/}[0m -h -h

 P≈ôehled akc√≠ vyp√≠≈°ete takto...

      [1m${0##*/}[0m [volby] <soubor> -h
"""
		;;
	esac
}

function todjvu {
	# $1 - soubor ke konverzi
	# $2 - c√≠lov√Ω DjVu soubor
	echo "todjvu: Konvertuji soubor $1 - do souboru $2" >> /dev/stderr
	echo "$(testfile ${1})" >> /dev/stderr
	if [ $(testfile ${1}) == "djvu" ] ; then
		echo "DjVu soubory nelze znovu konvertovat" >> /dev/stderr
		exit 1
	else
		if [ "${#ALG[@]}" -gt "1" ] ; then
			for i in ${ALG[@]} ; do 
				${DIDJVU} encode -o "${2/.djvu/.$i.djvu}" -d "${DPI-300}" ${LEVEL} -m "$i" "$1"
				getocr ${2/.djvu/.$i.djvu}
			done
		else
			if [ -f "${2}" ] ; then
				if [ "${FORCE}" == "yes" ] ; then
				log 1 "todjvu: C√≠lov√Ω soubor ${2} existuje, bude se p≈ôepisovat"
					${DIDJVU} encode -o "${2}" -d "${DPI-300}" ${LEVEL} -m "${ALG}" "${1}"
					getocr ${2}
				else
					echo "M√°m p≈ôepsat c√≠lov√Ω soubor ${2}?"
					potvrdit && ${DIDJVU} encode -o "${2}" -d "${DPI-300}" ${LEVEL} -m "${ALG}" "${1}"
					getocr ${2}
				fi
			else
				if [ ! -d "${2%/*}" ] ; then
					log 1 "todjvu: neexistuje adres√°≈ô pro c√≠lov√Ω soubor, mus√≠m ho vytvo≈ôit"
					mkdir -p "${2%/*}"
				fi
				log 1 "todjvu: konvertuji soubor ${1} do c√≠lov√©ho souboru $2"
				echo "${DIDJVU} encode -o ${2} -d ${DPI-300} ${LEVEL} -m ${ALG} ${1}" >> /dev/stderr
				${DIDJVU} encode -o "${2}" -d "${DPI-300}" ${LEVEL} -m "${ALG}" "${1}"
				getocr ${2}
			fi
		fi
	fi
}

function todotest {
	for i in ${ALG[@]} ; do 
		${DIDJVU} encode -o "${1%.*}-$i.djvu" -d 300 -m "$i" "$1"
	done
}

function todoview {
	for i in ${ALG[@]} ; do 
		(${DJVIEW} ${1%.*}-$i.djvu &)
	done
}

function todjvuclassic {
    RANDOMKEY=$[ 8000 + $[ RANDOM % 1000 ]]
    TEMP_DIR="${TEMPDIR}/$WINDOWID$BASHPID$RANDOMKEY"
    mkdir $TEMP_DIR
    TEMP_IMG="$TEMP_DIR/temp.ppm"
    TEMP_MASK="$TEMP_DIR/mask.pbm"
    DJVU_MASK="$TEMP_DIR/mask.djvu"

    case ${1##*.} in
        tiff|tif) KONVERT="${TIFFTOPNM}";;
        png) KONVERT="${PNGTOPNM}";;
        jpg) KONVERT="${JPEGTOPNM}" ;;
    esac

    $KONVERT $1 | tee $TEMP_IMG | ${PPMTOPGM} | ${PGMTOPBM} -threshold -value 0.${3-5} | ${PNMTOPLAINPNM} > $TEMP_MASK;
    ${CJB2} -lossy -clean $TEMP_MASK $DJVU_MASK;
    ${DJVUMAKE} ${1/.png/.djvu} Sjbz=$DJVU_MASK PPM=$TEMP_IMG;
    getocr ${1/.png/.djvu}
    rm -rf $TEMP_DIR
}

# Zpracov√°n√≠ parametr≈Ø p≈ôedan√Ωch p≈ôi startu skriptu
function main {
#local VSTUP="$@"
while [ $# -gt 0 ]
do case "$1" in
	-a|--algorithm) [ "$2" == "-h" ] && for i in ${ALG[@]} ; do 
					echo "$i"
				done && exit 0 || ALG="$2" ; shift
		;;
	-d|--dsed) if [ "$2" == "-h" ] ; then
				help exporttodsed && exit 0
			elif [ "${2}" == "yes" ] || [ "${2}" == "no" ] ; then
				DSED="${2}"
				shift
			else
				DSED="yes"
			fi
	;;
	-e|--ext) case "$2" in
			jpg|jpeg|png|tiff|pnm|pbm|gif|djvu) EXTENSION=".$2" && shift
				;;
				*) help suffix && exit 0
				;;
			esac
		;;
	-f|--force) if [ "$2" == "-h" ] ; then
				help force && exit 0
			else
				FORCE=yes
			fi
	;;
	--img) if [ "$2" == "-h" ] ; then
				help exporttopng && exit 0
			else
				case "${2}" in
					yes|no|color|black|foreground|background|mask) IMGPAGE="${2}" && shift
					;;
					*) IMGPAGE="yes"
					;;
				esac
			fi
		;;
	--dpi) if [ "$2" -ge "72" ] || [ "$2" -le "6000" ] ; then
				DPI="$2"
				shift
			else
				help dpi && exit 0
			fi
	;;
    -h) if [ "$2" == "-h" ] ; then
				help options
			else
				help
			fi
			exit 0
		;;
	--indirect) if [ "$2" == "-h" ] ; then
				help indirect && exit 0
			else
				INDIRECT=yes
			fi
	;;
	--clean) LEVEL="--loss-level=1"
	;;
	--lossy) LEVEL="--loss-level=100"
	;;
	--lossless) LEVEL="--loss-level=0"
	;;
	--loss-level) if [ "$2" -ge "0" ] || [ "$2" -lt "200" ] ; then
				LEVEL="--loss-level=1"
				shift
			else
				help level && exit 0
			fi
		;;
	--manual) [ -f $0.manual ] && less -R $0.manual
		exit 0
		;;
	-m|--meta) if [ "$2" == "-h" ] ; then
				help exporttometa && exit 0
			elif [ "${2}" == "yes" ] || [ "${2}" == "no" ] ; then
				EXTRACTMETA="${2}"
				shift
			else
				EXTRACTMETA="yes"
			fi
		;;
	--pdf) PDF2DJVU=$(which pdf2djvu)
[ ! ${PDF2DJVU} ] && echo 'Nen√≠ nainstalov√°n bal√≠k pdf2djvu, kter√Ω je nezbytn√Ω pokud chcete prov√©st p≈ô√≠mou konverzi PDF souboru do DjVu form√°tu' && PDF2DJVU=false
	;;
	-o|--ocr) if [ "$2" == "-h" ] ; then
				help ocr && exit 0
			elif [ "${#2}" == "3" ] ; then
				OCR="$2"
				shift
			else
				OCR="ces"
			fi
		;;
	-p|--page) if [ "$2" == "-h" ] ; then
				help exporttodjvu && exit 0
			elif [ "${2}" == "yes" ] || [ "${2}" == "no" ] ; then
				EXTRACTPAGE="${2}"
				shift
			else
				EXTRACTPAGE="yes"
			fi
		;;
	-r|--rename) case "$2" in
		*0) RENAME="$2" && shift
				;;
		*) help rename && exit 0
			;;
		esac
		;;
	--test) TEST="yes"
			# Implementovat volby --test-conversion a --test-view
		;;
	--test-conversion) ALG="abutaleb bernsen brink djvu niblack otsu sauvola shading-subtraction"
		TEST="yes"
		;;
	--test-view) # Zobrazen√≠ testovac√≠ho souboru pomoc√≠ djview
			echo "Je≈°tƒõ neimplementov√°no"
			exit 100
			if [ -f "$2" ] ; then
				# P≈ôed√°v√° se soubor... obr√°zek ƒçi nƒõco jin√©ho?
				todoview "${2}"
			elif [ -d "$2" ] ; then
				# P≈ôed√°v√° se adres√°≈ô
				echo "Je≈°tƒõ nen√≠ implementov√°no"
			else
				$0 -h
				exit 0
			fi
		;;
	-x|--xml) if [ "$2" == "-h" ] ; then
				help exporttoxml && exit 0
			elif [ "${2}" == "yes" ] || [ "${2}" == "no" ] ; then
				XML="${2}"
				shift
			else
				XML="yes"
			fi
		;;
	-t|--thumb) if [ "$2" == "-h" ] ; then
				help exporttothumb && exit 0
			elif [ "${2}" == "yes" ] || [ "${2}" == "no" ] ; then
				THUMBNAIL="${2}"
				shift
			else
				THUMBNAIL="yes"
			fi
		;;
	*) #P≈ôedan√Ω parametr nen√≠ zachycen p≈ôedchoz√≠ch volb√°ch
	# M≈Ø≈æe to b√Ωt ≈ôetƒõzec, nebo ≈ôetƒõzec s mezerami
	# v takov√©m p≈ô√≠padƒõ m≈Ø≈æe b√Ωt rozhoduj√≠c√≠ v√Ωskyt kl√≠ƒçov√©ho slova ve zbytku...
	# Sjet ve smyƒçce zbytek p≈ô√≠kazov√© ≈ô√°dky a otestovat ji na v√Ωskyt kl√≠ƒçov√©ho slova---
	# P≈ôeru≈°it..
#	echo "P≈ôed√°no: ${VSTUP}" >> /dev/stderr
	local CHARSTRING="${@:1}"
	local CHARCOUNT=$((${#CHARSTRING} + 1))
	local CHARPOS=0
	local STRPOS=0
	while [ "${CHARCOUNT}" -gt "0" ] ; do
#		echo "${CHARSTRING}" >> /dev/stderr
		case "${CHARSTRING:0:$((${CHARPOS} - ${STRPOS}))}" in
			*.[dD][jJ][vV][uU]|*.[gG][iI][fF]|*.[jJ][pP][gG]|*.[mM][nN][gG]|*.[pP][dD][fF]|*.[pP][nN][gG]|*.[pP][nN][mM]|*.[tT][iI][fF][fF]|*.[xX][cC][fF]) local FILE="${CHARSTRING:0:$((${CHARPOS} - ${STRPOS}))}"
#				echo "Soubor... -${FILE}-" >> /dev/stderr
				local STRPOS="${CHARPOS}"
				local CHARSTRING="${CHARSTRING#${FILE}}"
#				echo "Zbytek.. ${CHARSTRING}" >> /dev/stderr
				local CHARCOUNT=$((${#CHARSTRING} + 1))
			;;
			\ back |\ delete |\ export |\ fore |\ import |\ info |\ print |\ rotate |\ set |\ unset ) local KEY="${CHARSTRING:0:$((${CHARPOS} - ${STRPOS}))}"
#				echo "Kl√≠ƒç.. ${KEY}" >> /dev/stderr
				local STRPOS="${CHARPOS}"
				local CHARSTRING="${CHARSTRING#${KEY}}"
#				echo "Zbytek.. ${CHARSTRING}" >> /dev/stderr
				break
				local CHARCOUNT=$((${#CHARSTRING} + 1))
			;;
		esac
		local CHARPOS=$((CHARPOS + 1))
		local CHARCOUNT=$((CHARCOUNT - 1))
	done
#	echo "Soubor se kter√Ωm budu pracovat: ${FILE}" >> /dev/stderr 
#	echo "Akce kterou chci realizovat: ${KEY}" >> /dev/stderr 
#	echo "Zbytek co j√≠ p≈ôed√°m: ${CHARSTRING}" >> /dev/stderr
	case "${CHARSTRING// /}" in
		*-h|*--help|-h*|--help*) if [ -z "${KEY}" ] ; then
				help
			else
				echo "keywords-${KEY// /}" >> /dev/stderr
				help "keywords-${KEY// /}"
			fi
			exit 77
		;;
	esac

	if [ -z "{FILE}" ] ; then
		# Nebyl p≈ôed√°n soubor
#		echo "Ve zbytku m≈Ø≈æe b√Ωt cesta do adres√°≈ôe..."
		if [ -d "${CHARSTRING}" ] ; then
			echo "Byl p≈ôed√°n adres√°≈ô ${CHARSTRING}" >> /dev/stderr
			echo "ToDo" >> /dev/stderr
			exit 0
		else
			echo "Byl p≈ôed√°n neplatn√Ω ≈ôetƒõzec ${CHARSTRING}" >> /dev/stderr
			exit 1
		fi
	else
#		local FILE="$(escape_path ${FILE})"
		local FILE=$(${REALPATH} "${FILE}")
		# Tady je k dispozici soubor ke zpracov√°n√≠...
		if [ -f "${FILE}" ] ; then
#			log 1 "main: Soubor -${FILE}- existuje.."
#			FILE=${FILE//\ /\\ }
			case $(testfile "${FILE}") in
				djvu)
					#echo "AKCE ${KEY}" >> /dev/stderr
					#echo "Parametry #${CHARSTRING}#" >> /dev/stderr
					case "${KEY// /}" in
						delete) deletepage "${FILE}" "${CHARSTRING}"
							exit 0
						;;
						insert) # ToDo - zpracovat ${CHARSTRING}
							exit 1
								if [ -f "${3}" ] ; then
								if [ $(testfile ${3}) == "djvu" ] ; then
									log 1 "main - insert: Soubor je typu djvu"
									local INSERTFILE=${3}
								else
									[ "${#ALG[@]}" == "1" ] || exit 32
									local INSERTFILE="$TEMPDIR/${3%.*}.djvu"
									todjvu ${3} ${INSERTFILE}
									if [ $? -gt "0" ] ; then
										echo "main - insert: Soubor ${3} se nepoda≈ôilo zkonvertovat do souboru ${INSERTFILE}" >> /dev/stderr
										exit 1
									fi
								fi
								# Urƒçit pozici...
								local P=$(identifypage ${1} ${4})
								log 1 "main - insert: C√≠lov√° pozice je $P"
								if [ -z "${P}" ] ; then
									if [ -z "${4}" ] ; then
										echo "P≈ôipojen√≠ souboru ${INSERTFILE} na konec souboru ${1}" >> /dev/stderr
										insertpage ${1} ${INSERTFILE}
									else
										echo "Identifik√°tor ${4} je pro soubor ${1} neplatn√Ω" >> /dev/stderr
										exit 1
									fi
								else
									log 1 "main - insert: Vkl√°d√°m ${INSERTFILE} na pozici $P"
									insertpage ${1} ${INSERTFILE} ${P}
								fi
							else
								echo "Akci insert lze pou≈æ√≠t pouze ke vlo≈æen√≠ souboru" >> /dev/stderr
								exit 1
							fi
							exit 0
						;;
						set) setmeta "${FILE}" "${CHARSTRING}"
							exit 0
						;;
						print) printmeta ${FILE} "${CHARSTRING}"
							exit 0
						;;
						unset) unsetmeta ${FILE} "${CHARSTRING}"
							exit 0
						;;
						fore)  # ToDo - zpracovat ${CHARSTRING}
							exit 1
								[ -f ${3} ] && echo "pro vlo≈æen√≠ nov√© str√°nky do souboru je urƒçena akce insert" >> /dev/stderr && exit 1
#								echo "akce forvard ${1} - ${3} - ${4}" >> /dev/stderr
								forwardpage ${1} ${3} ${4}
								exit 0
							;;
						back)  # ToDo - zpracovat ${CHARSTRING}
							exit 1
							[ -f ${3} ] && echo "pro vlo≈æen√≠ nov√© str√°nky do souboru je urƒçena akce insert" >> /dev/stderr && exit 1
								backpage ${1} ${3} ${4}
								exit 0
						;;
						rotate) rotatepage "${FILE}" "${CHARSTRING}"
								exit 0
						;;
						export)   # ToDo - zpracovat ${CHARSTRING}
							exit 1
								exportpage ${FILE} ${CHARSTRING}
								exit 0
							;;
						import)   # ToDo - zpracovat ${CHARSTRING}
							exit 1
							;;
						info) djvuinfo "${FILE}" "${CHARSTRING}"
								exit 0
							;;
						rename)   # ToDo - zpracovat ${CHARSTRING}
							exit 1
							;;
							*) help keywords && exit 0
							;;
						esac
				;;
				jpeg|png) echo "Bude se zpracov√°vat soubor v bitmapov√©m form√°tu"
					echo "ToDo"
					exit 1
				;;
				xcf|tiff|mng) echo "Jako druh√Ω parametr je soubor ve v√≠cevrstv√©m bitmapov√©m form√°tu. Zpracov√°n√≠ tƒõchto soubor≈Ø nen√≠ zat√≠m implementov√°no" >> /dev/stderr
					exit 1
				;;
				xml|XML) echo "m√°-li prvn√≠ soubor p≈ô√≠ponu xml"
					echo "ToDo"
					exit 1
				;;
				unknown) echo "Pokud je soubor ${1} typu DjVU, m≈Ø≈æe j√≠t o tzv. SecureDjVu form√°t, kter√Ω m√° kryptovan√© vrstvy. S takov√Ωm souborem nelze s opensource n√°stroji pracovat." >> /dev/stderr
				exit 1
				;;
				*) echo "${FILE} : $(testfile ${FILE})" >> /dev/stderr
					echo '''Pokud n√°sleduje djvu soubor'''
					echo '''Pokud n√°sleduje adres√°≈ô'''
					echo '''to je existuj√≠c√≠ soubor typu bundle a:
					- nen√°sleduje ≈æ√°dn√Ω dal≈°√≠ existuj√≠c√≠ soubor typu djvu, nebo adres√°≈ô
					a z√°rove≈à existuje $DIRECTORY, pak to znamen√° ≈æe se m√° rozbalit
					- pokud n√°sleduje dal≈°√≠ soubor, pak to znamen√° ≈æe se m√° nƒõjak√Ωm zp≈Øsobem s t√≠mto dal≈°√≠m souborem nalo≈æit. Je-li to:
					- djvu soubor, m√° se p≈ôipojit
					- xml soubor, m√° se vlo≈æit
					- soubor typu dsed m√° se zpracovat
					- jin√Ω soubor - obr√°zek, kter√Ω se m√° p≈ôev√©st a vlo≈æit
					'''
				

					echo "Zpracov√°n√≠ soubor≈Ø jako je $2 zat√≠m nen√≠ implementov√°no"
					exit 1
				;;
			esac
		log 1 "main: Tudy m≈Ø≈æe projet pouze v p≈ô√≠padƒõ, ≈æe polo≈æka ${1} je existuj√≠c√≠ soubor a nen√≠ odchycena nƒõkterou z akc√≠"
		else
			echo "Chyst√°te se zpracov√°vat neexistuj√≠c√≠ soubor ${FILE}" >> /dev/stderr
			echo "ToDo"
			exit 1
		fi
	fi
# xxxxxxx
echo '''
	elif [ -d "${1}" ] ; then
		log 1 "main: Sem spadne pouze existuj√≠c√≠ adres√°≈ô - to m≈Ø≈æe znamenat, ≈æe se bude d√°le pracovat v nƒõm, nebo s n√≠m - z√°le≈æ√≠ na dal≈°√≠ch parametrech"
			DIRECTORY="${1:0:$((${#1}-1))}"
	elif [ -z "${2}" ] ; then
		log 1 "main: Sem se spadne, je-li n√°sleduj√≠c√≠ polo≈æka pr√°zdn√°"
	elif [ "${2}" == "-h" ] || [ "${2}" == "--help" ] ; then
		help
		exit 0
	else
		log 1 "main: Sem se spadne, pokud p≈ôedch√°zej√≠c√≠ polo≈æka ${1} nen√≠ adres√°≈ô a nevede tak√© existuj√≠c√≠ soubor"
		echo "main: ${1} $(testfile ${1})" >> /dev/stderr
			if [ "${1:$((${#1}-1)):1}" == "/" ] ; then
				if [ "${2:$((${#2}-5))}" == ".djvu" ] ; then
					log 1 "main: Rozbalen√≠ DjVu svazku : Prvn√≠ polo≈æka je jm√©no adres√°≈ôe a druh√° DjVu soubor, kter√Ω se m√° rozbalit"
					djvuunbundle "$1" "$2" 
					exit 0
				else
					if [ -f "{2}" ] ; then
						log 1 "main: Prvn√≠ polo≈æka je jm√©no adres√°≈ôe a druh√° jm√©no existuj√≠c√≠ho souboru, kter√Ω nen√≠ typu DjVu"
					else
						log 1 "main: Prvn√≠ polo≈æka je jm√©no adres√°≈ôe a druh√° ≈ôetƒõzec - pravdƒõpodobnƒõ bude n√°sledovat polo≈æka t≈ôet√≠... to mohl b√Ωt vzorek"
					fi
				fi
			elif [ "${2:$((${#2}-5))}" == ".djvu" ] ; then
				log 1 "main: Sestaven√≠ DjVu svazku - konverze, OCR, textov√© soubory, n√°hled, integrace a nakonec sestaven√≠"
				# $1 vzorek
				# $2 jm√©no budouc√≠ho DjVu svazku
				# $2 ƒç√≠slo souboru, kter√Ω se m√° zpracovat (nen√≠-li uvedeno, zpracuj√≠ se v≈°echny)
				djvubundle "$1" "$2" "$3"
				exit 0
			else
				log 1 "Sem to propadne, kdy≈æ soubor ${1} nebyl rozpozn√°n jako djvu soubor..."
				case "${2:$((${#2}-3))}" in
					tiff) echo "Soubor $1 se bude exportovat do souboru $2"
						;;
					pdf) echo "Soubor $1 se bude exportovat do souboru $2"
						;;
					xcf) echo "za ≈ôetƒõzcem n√°sleduje jm√©no xcf souboru, tak≈æe pokud neexistuje $DIRECTORY, je $1 - jm√©no budouc√≠ho djvu souboru a $2 jm√©no v√≠cevrstv√©ho xcf souboru."
						echo "zavolat funkci pro konverzi xcf2djvu a skonƒçit"
						exit 0
						;;
					mng) echo "Soubor $1 se bude exportovat do souboru $2"
						;;
					*) echo "Pokud zpracov√°n√≠ p≈ô√≠kazov√© ≈ô√°dky do≈°lo a≈æ sem, tak to znamen√°, ≈æe je pravdƒõpodobnƒõ chybnƒõ uveden√© jm√©no DjVu souboru se kter√Ωm se m√° pracovat. Zkontrolujte, zda n√°sleduj√≠c√≠ jm√©no skuteƒçnƒõ odpov√≠d√° jm√©nu souboru se kter√Ωm chcete pracovat - ${1}"
						exit 1
						;;
				esac
			fi
	fi
''' > /dev/null
# xxxxxxx
	;;
	esac
	shift
done
}

main "$*"

exit 0
